<!-- View recebe uma lista de pedidos -->
@model IEnumerable<Fynanceo.Models.Pedido>
@using Fynanceo.Models.Enums;

@{
    ViewData["Title"] = "Pedidos do Dia"; // Título da página
}
@* <link rel="stylesheet" href="/css/pedidosIndex.css"> *@
<link rel="stylesheet" href="~/css/pedidosIndex.css" asp-append-version="true" />

<!-- Cabeçalho com título e botão para novo pedido -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 mb-0">
        <i class="fas fa-shopping-cart text-primary me-2"></i>@ViewData["Title"]
    </h1>

    <!-- Botão para criar novo pedido -->
    <a href="@Url.Action("Create")" class="btn btn-primary">
        <i class="fas fa-plus me-2"></i>Novo Pedido
    </a>
</div>

<!-- Cards de contagem por status -->
<div class="row mb-4">

    <!-- Quantidade de pedidos abertos -->
    <div class="col">
        <div class="card bg-info text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <!-- Conta quantos pedidos estão Abertos -->
                        <h4 class="mb-0">@Model.Count(p => p.Status == PedidoStatus.Aberto)</h4>
                        <small>Abertos</small>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-clock fa-2x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Pedidos em preparo -->
    <div class="col">
        <div class="card bg-warning text-dark">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <!-- Conta EmPreparo -->
                        <h4 class="mb-0">@Model.Count(p => p.Status == PedidoStatus.EmPreparo)</h4>
                        <small>Em Preparo</small>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-utensils fa-2x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Pedidos prontos -->
    <div class="col">
        <div class="card bg-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <!-- Conta Pronto -->
                        <h4 class="mb-0">@Model.Count(p => p.Status == PedidoStatus.Pronto)</h4>
                        <small>Prontos</small>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-check fa-2x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Pedidos em rota -->
    <div class="col">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <!-- Conta EmRota -->
                        <h4 class="mb-0">@Model.Count(p => p.Status == PedidoStatus.EmRota)</h4>
                        <small>Em Rota</small>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-check fa-2x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Pedidos fechados -->
    <div class="col">
        <div class="card bg-secondary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <!-- Conta Fechado -->
                        <h4 class="mb-0">@Model.Count(p => p.Status == PedidoStatus.Fechado)</h4>
                        <small>Finalizados</small>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-flag-checkered fa-2x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    
    
</div>

<!-- Tabela de pedidos -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Todos os Pedidos de Hoje</h5>

        <!-- Campo de busca e botões de filtro -->
        <div class="d-flex gap-2">

            <!-- Input de busca por número do pedido -->
            <div class="input-group input-group-sm" style="width: 250px;">
                <input type="text" id="searchInput" class="form-control" placeholder="Buscar por nº pedido...">

                <!-- Botão para limpar busca -->
                <button class="btn btn-outline-secondary" type="button" onclick="clearSearch()">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <!-- Botões de filtro de status -->
            <div class="btn-group">
                <button class="btn btn-outline-secondary btn-sm" onclick="filterPedidos('all')">Todos</button>
                <button class="btn btn-outline-primary btn-sm" onclick="filterPedidos('Aberto')">Abertos</button>
                <button class="btn btn-outline-warning btn-sm" onclick="filterPedidos('EmPreparo')">Preparo</button>
                <button class="btn btn-outline-success btn-sm" onclick="filterPedidos('Pronto')">Prontos</button>
            </div>
        </div>
    </div>

    <!-- Corpo da tabela -->
    <div class="card-body">
        <div class="table-responsive">

            <table class="table table-hover" id="pedidosTable">
                <thead>
                    <tr>
                        <th>Nº Pedido</th>
                        <th>Tipo</th>
                        <th>Cliente/Mesa</th>
                        <th>Itens</th>
                        <th>Total</th>
                        <th>Status</th>
                        <th>Tempo</th>
                        <th>Ações</th>
                    </tr>
                </thead>

                <tbody>
                    @foreach (var pedido in Model)
                    {
                        <!-- Linha da tabela com atributos para filtro -->
                        <tr class="pedido-row"
                            data-status="@pedido.Status"
                            data-numero="@pedido.NumeroPedido">

                            <!-- Número do pedido + hora da abertura -->
                            <td>
                                <strong>@pedido.NumeroPedido</strong>
                                <br>
                                <small class="text-muted">
                                    @pedido.DataAbertura.ToLocalTime().ToString("HH:mm")
                                </small>
                            </td>

                            <!-- Tipo do pedido -->
                            <td>
                                @switch (pedido.TipoPedido)
                                {
                                    case TipoPedido.Mesa:
                                        <span class="badge bg-info">Mesa</span>
                                        break;

                                    case TipoPedido.Balcao:
                                        <span class="badge bg-secondary">Balcão</span>
                                        break;

                                    case TipoPedido.Delivery:
                                        <span class="badge bg-warning text-dark">Delivery</span>
                                        break;
                                }
                            </td>

                            <!-- Cliente ou Mesa -->
                            <td>
                                @if (pedido.TipoPedido == TipoPedido.Mesa && pedido.Mesa != null)
                                {
                                    <text>Mesa @pedido.Mesa.Numero</text>
                                }
                                else if (pedido.TipoPedido == TipoPedido.Delivery && pedido.Cliente != null)
                                {
                                    <text>@pedido.Cliente.NomeCompleto</text>
                                }
                                else
                                {
                                    <text>Balcão</text>
                                }
                            </td>

                            <!-- Quantidade e primeiro item -->
                            <td>
                                <small>
                                    @pedido.Itens.Count item(s)
                                    @if (pedido.Itens.Any())
                                    {
                                        <br />
                                        <span class="text-muted">
                                            @pedido.Itens.First().Produto?.Nome
                                        </span>

                                        <!-- Exibe “+X outros” caso tenha mais itens -->
                                        @if (pedido.Itens.Count > 1)
                                        {
                                            <text> + @(pedido.Itens.Count - 1) outros</text>
                                        }
                                    }
                                </small>
                            </td>

                            <!-- Total do pedido -->
                            <td>
                                <strong>R$ @pedido.Total.ToString("N2")</strong>
                            </td>

                            <!-- Badge com status -->
                            <td>
                                @{
                                    string statusClass = "";
                                    string statusText = "";

                                    // Define badge conforme o status
                                    switch (pedido.Status)
                                    {
                                        case PedidoStatus.Aberto:
                                            statusClass = "status-aberto";
                                            statusText = "Aberto";
                                            break;

                                        case PedidoStatus.EnviadoCozinha:
                                            statusClass = "status-cozinha";
                                            statusText = "Cozinha";
                                            break;

                                        case PedidoStatus.EmPreparo:
                                            statusClass = "status-preparo";
                                            statusText = "Preparo";
                                            break;

                                        case PedidoStatus.Pronto:
                                            statusClass = "status-pronto";
                                            statusText = "Pronto";
                                            break;

                                        case PedidoStatus.EmRota:
                                            statusClass = "status-rota";
                                            statusText = "Em Rota";
                                            break;

                                        case PedidoStatus.Entregue:
                                            statusClass = "status-entregue";
                                            statusText = "Entregue";
                                            break;

                                        case PedidoStatus.Fechado:
                                            statusClass = "status-fechado";
                                            statusText = "Fechado";
                                            break;
                                        case PedidoStatus.Cancelado:
                                            statusClass = "status-cancelado";
                                            statusText = "Cancelado";
                                            break;
                                    }
                                }

                                <!-- Renderiza o badge -->
                                <span class="status-badge @statusClass">@statusText</span>
                            </td>

                            <!-- Tempo desde abertura do pedido -->
                            <td>
                                @{
                                    var tempoDecorrido =
                                        DateTime.Now - pedido.DataAbertura.ToLocalTime();
                                }
                                <small>@((int)tempoDecorrido.TotalMinutes)m</small>
                            </td>

                            <!-- Botões de ação -->
                            <td>
                                <div class="btn-group btn-group-sm">

                                    <!-- Detalhes -->
                                    <a href="@Url.Action("Details", new { id = pedido.Id })"
                                       class="btn btn-outline-primary"
                                       title="Detalhes">
                                        <i class="fas fa-eye"></i>
                                    </a>

                                    <!-- Editar somente se não estiver fechado -->
                                    @if (pedido.Status != PedidoStatus.Fechado)
                                    {
                                        <a href="@Url.Action("Edit", new { id = pedido.Id })"
                                           class="btn btn-outline-secondary"
                                           title="Editar">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                    }
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>

        </div>
    </div>
</div>

<script src="/js/Pedidos/Pedidos.js"></script>



