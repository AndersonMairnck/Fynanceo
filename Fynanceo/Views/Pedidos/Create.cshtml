<!-- Views/Pedidos/Create.cshtml -->
@model Fynanceo.ViewModels.PedidoViewModel

@{
    ViewData["Title"] = "Novo Pedido";
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 mb-0">
        <i class="fas fa-plus-circle text-primary me-2"></i>@ViewData["Title"]
    </h1>
    <a href="@Url.Action("Index")" class="btn btn-outline-secondary">
        <i class="fas fa-arrow-left me-2"></i>Voltar
    </a>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Informações do Pedido</h5>
            </div>
            <div class="card-body">
                <form asp-action="Create" id="pedidoForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="TipoPedido" class="form-label">Tipo de Pedido *</label>
                                <select asp-for="TipoPedido" class="form-select" id="tipoPedidoSelect" required>
                                    <option value="">Selecione...</option>
                                    <option value="1">Mesa</option>
                                    <option value="2">Balcão</option>
                                    <option value="3">Delivery</option>
                                </select>
                                <span asp-validation-for="TipoPedido" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3" id="mesaField" style="display: none;">
                                <label asp-for="MesaId" class="form-label">Mesa *</label>
                                <select asp-for="MesaId" class="form-select" asp-items="@(new SelectList(Model.MesasDisponiveis ?? new List<Fynanceo.Models.Mesa>(), "Id", "Numero"))">
                                    <option value="">Selecione a mesa...</option>
                                </select>
                                <span asp-validation-for="MesaId" class="text-danger"></span>
                            </div>

                            <div class="mb-3" id="clienteField" style="display: none;">
                                <label asp-for="ClienteId" class="form-label">Cliente *</label>
                                <select asp-for="ClienteId" class="form-select" id="clienteSelect">
                                    <option value="">Selecione o cliente...</option>
                                    @foreach (var cliente in Model.Clientes ?? new List<Fynanceo.Models.Cliente>())
                                    {
                                        <option value="@cliente.Id">@cliente.NomeCompleto</option>
                                    }
                                </select>
                                <span asp-validation-for="ClienteId" class="text-danger"></span>
                            </div>
                        </div>
                    </div>

                    <div class="row" id="deliveryFields" style="display: none;">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="EnderecoEntregaId" class="form-label">Endereço de Entrega</label>
                                <select asp-for="EnderecoEntregaId" class="form-select" id="enderecoSelect">
                                    <option value="">Selecione o endereço...</option>
                                </select>
                                <span asp-validation-for="EnderecoEntregaId" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="TaxaEntrega" class="form-label">Taxa de Entrega</label>
                                <input asp-for="TaxaEntrega" type="number" step="0.01" class="form-control" value="0" />
                                <span asp-validation-for="TaxaEntrega" class="text-danger"></span>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label asp-for="Observacoes" class="form-label">Observações</label>
                        <textarea asp-for="Observacoes" class="form-control" rows="3" placeholder="Observações especiais do pedido..."></textarea>
                        <span asp-validation-for="Observacoes" class="text-danger"></span>
                    </div>
                </form>
            </div>
        </div>

        <!-- Seção de Produtos -->
        <div class="card mt-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Itens do Pedido</h5>
                <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#produtoModal">
                    <i class="fas fa-plus me-1"></i>Adicionar Item
                </button>
            </div>
            <div class="card-body">
                <div id="itensPedido">
                    <!-- Itens serão adicionados aqui via JavaScript -->
                    <div class="text-center text-muted py-4" id="emptyMessage">
                        <i class="fas fa-shopping-cart fa-2x mb-3"></i>
                        <p>Nenhum item adicionado ao pedido</p>
                    </div>
                </div>

                <div class="mt-4 pt-3 border-top" id="resumoPedido" style="display: none;">
                    <div class="row">
                        <div class="col-md-6">
                            <strong>Subtotal:</strong> <span id="subtotal">R$ 0,00</span><br>
                            <strong>Taxa de Entrega:</strong> <span id="taxaEntrega">R$ 0,00</span>
                        </div>
                        <div class="col-md-6 text-end">
                            <h4>Total: <span id="totalPedido">R$ 0,00</span></h4>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <!-- Resumo Rápido -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Resumo do Pedido</h5>
            </div>
            <div class="card-body">
                <div id="resumoRapido">
                    <p class="text-muted">Preencha as informações do pedido</p>
                </div>

                <div class="d-grid gap-2 mt-3">
                    <button type="submit" form="pedidoForm" class="btn btn-success btn-lg">
                        <i class="fas fa-check me-2"></i>Finalizar Pedido
                    </button>
                    <button type="button" class="btn btn-outline-danger" onclick="limparPedido()">
                        <i class="fas fa-times me-2"></i>Cancelar
                    </button>
                </div>
            </div>
        </div>

        <!-- Produtos em Destaque -->
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0">Produtos Populares</h5>
            </div>
            <div class="card-body">
                <div class="list-group list-group-flush">
                    @foreach (var produto in Model.ProdutosDisponiveis?.Take(5) ?? new List<Fynanceo.Models.Produto>())
                    {
                        <button type="button" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                                onclick="adicionarProdutoRapido(@produto.Id, '@produto.Nome', @produto.ValorVenda)">
                            <div>
                                <strong>@produto.Nome</strong>
                                <br>
                                <small class="text-muted">R$ @produto.ValorVenda.ToString("N2")</small>
                            </div>
                            <span class="badge bg-primary rounded-pill">
                                <i class="fas fa-plus"></i>
                            </span>
                        </button>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Produtos -->
<div class="modal fade" id="produtoModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Adicionar Produto</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <input type="text" class="form-control" id="searchProduto" placeholder="Buscar produto...">
                </div>

                <div class="row" id="listaProdutos">
                    @foreach (var produto in Model.ProdutosDisponiveis ?? new List<Fynanceo.Models.Produto>())
                    {
                        <div class="col-md-6 mb-3 produto-item" data-nome="@produto.Nome.ToLower()">
                            <div class="card h-100">
                                <div class="card-body">
                                    <h6 class="card-title">@produto.Nome</h6>
                                    <p class="card-text text-muted small">@produto.Descricao</p>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <strong class="text-primary">R$ @produto.ValorVenda.ToString("N2")</strong>
                                        <button type="button" class="btn btn-sm btn-outline-primary"
                                                onclick="selecionarProduto(@produto.Id, '@produto.Nome', @produto.ValorVenda)">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Quantidade -->
<div class="modal fade" id="quantidadeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="quantidadeModalTitle">Adicionar Produto</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="produtoSelecionadoId">
                <input type="hidden" id="produtoSelecionadoNome">
                <input type="hidden" id="produtoSelecionadoPreco">

                <div class="mb-3">
                    <label class="form-label">Quantidade</label>
                    <input type="number" class="form-control" id="quantidadeProduto" value="1" min="0.1" step="0.1">
                </div>

                <div class="mb-3">
                    <label class="form-label">Observações</label>
                    <textarea class="form-control" id="observacoesProduto" rows="2" placeholder="Ex: Sem cebola, ponto da carne etc."></textarea>
                </div>

                <div class="mb-3">
                    <label class="form-label">Personalizações</label>
                    <textarea class="form-control" id="personalizacoesProduto" rows="2" placeholder="Ex: Borda recheada, extra bacon etc."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="adicionarItemPedido()">Adicionar</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let itensPedido = [];
        let currentProduto = null;

        // Controle do tipo de pedido
        $('#tipoPedidoSelect').change(function() {
            const tipo = $(this).val();

            // Reset campos
            $('#mesaField, #clienteField, #deliveryFields').hide();
            $('#MesaId, #ClienteId').val('');

            switch(tipo) {
                case '1': // Mesa
                    $('#mesaField').show();
                    break;
                case '2': // Balcão
                    $('#clienteField').show();
                    break;
                case '3': // Delivery
                    $('#clienteField, #deliveryFields').show();
                    break;
            }

            atualizarResumo();
        });

        // Buscar endereços do cliente
        $('#clienteSelect').change(function() {
            const clienteId = $(this).val();
            if (clienteId) {
                $.get('/Pedidos/GetEnderecosCliente?clienteId=' + clienteId, function(data) {
                    const select = $('#enderecoSelect');
                    select.empty().append('<option value="">Selecione o endereço...</option>');
                    data.forEach(endereco => {
                        select.append(`<option value="${endereco.id}">${endereco.enderecoCompleto}</option>`);
                    });
                });
            }
        });

        // Busca de produtos
        $('#searchProduto').on('input', function() {
            const termo = $(this).val().toLowerCase();
            $('.produto-item').each(function() {
                const nome = $(this).data('nome');
                $(this).toggle(nome.includes(termo));
            });
        });

        // Selecionar produto para adicionar
        function selecionarProduto(id, nome, preco) {
            currentProduto = { id, nome, preco };
            $('#produtoSelecionadoId').val(id);
            $('#produtoSelecionadoNome').val(nome);
            $('#produtoSelecionadoPreco').val(preco);
            $('#quantidadeModalTitle').text(`Adicionar ${nome}`);
            $('#quantidadeProduto').val(1);
            $('#observacoesProduto').val('');
            $('#personalizacoesProduto').val('');

            $('#produtoModal').modal('hide');
            $('#quantidadeModal').modal('show');
        }

        // Adicionar produto rápido
        function adicionarProdutoRapido(id, nome, preco) {
            currentProduto = { id, nome, preco };
            $('#produtoSelecionadoId').val(id);
            $('#produtoSelecionadoNome').val(nome);
            $('#produtoSelecionadoPreco').val(preco);
            $('#quantidadeModalTitle').text(`Adicionar ${nome}`);
            $('#quantidadeProduto').val(1);
            $('#observacoesProduto').val('');
            $('#personalizacoesProduto').val('');

            $('#quantidadeModal').modal('show');
        }

        // Adicionar item ao pedido
        function adicionarItemPedido() {
            const quantidade = parseFloat($('#quantidadeProduto').val());
            const observacoes = $('#observacoesProduto').val();
            const personalizacoes = $('#personalizacoesProduto').val();

            if (quantidade <= 0) {
                alert('Quantidade deve ser maior que zero');
                return;
            }

            const item = {
                produtoId: currentProduto.id,
                produtoNome: currentProduto.nome,
                precoUnitario: currentProduto.preco,
                quantidade: quantidade,
                observacoes: observacoes,
                personalizacoes: personalizacoes,
                total: quantidade * currentProduto.preco
            };

            itensPedido.push(item);
            atualizarListaItens();
            $('#quantidadeModal').modal('hide');
        }

        // Atualizar lista de itens na tela
        function atualizarListaItens() {
            const container = $('#itensPedido');
            const emptyMessage = $('#emptyMessage');
            const resumoPedido = $('#resumoPedido');

            if (itensPedido.length === 0) {
                emptyMessage.show();
                resumoPedido.hide();
                container.find('.item-pedido').remove();
                return;
            }

            emptyMessage.hide();
            resumoPedido.show();

            // Limpar itens existentes (exceto empty message)
            container.find('.item-pedido').remove();

            itensPedido.forEach((item, index) => {
                const itemHtml = `
                    <div class="item-pedido border-bottom pb-3 mb-3">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <h6 class="mb-1">${item.produtoNome}</h6>
                                <div class="text-muted small">
                                    ${item.quantidade} x R$ ${item.precoUnitario.toFixed(2)} = R$ ${item.total.toFixed(2)}
                                    ${item.observacoes ? `<br><strong>Obs:</strong> ${item.observacoes}` : ''}
                                    ${item.personalizacoes ? `<br><strong>Personalizações:</strong> ${item.personalizacoes}` : ''}
                                </div>
                            </div>
                            <button type="button" class="btn btn-sm btn-outline-danger ms-2" onclick="removerItem(${index})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
                container.append(itemHtml);
            });

            atualizarResumo();
        }

        // Remover item do pedido
        function removerItem(index) {
            itensPedido.splice(index, 1);
            atualizarListaItens();
        }

        // Atualizar resumo financeiro
        function atualizarResumo() {
            const subtotal = itensPedido.reduce((sum, item) => sum + item.total, 0);
            const taxaEntrega = parseFloat($('#TaxaEntrega').val()) || 0;
            const total = subtotal + taxaEntrega;

            $('#subtotal').text(`R$ ${subtotal.toFixed(2)}`);
            $('#taxaEntrega').text(`R$ ${taxaEntrega.toFixed(2)}`);
            $('#totalPedido').text(`R$ ${total.toFixed(2)}`);

            // Atualizar resumo rápido
            const resumoRapido = $('#resumoRapido');
            if (itensPedido.length > 0) {
                resumoRapido.html(`
                    <p><strong>Itens:</strong> ${itensPedido.length}</p>
                    <p><strong>Subtotal:</strong> R$ ${subtotal.toFixed(2)}</p>
                    <p><strong>Taxa:</strong> R$ ${taxaEntrega.toFixed(2)}</p>
                    <p><strong>Total:</strong> R$ ${total.toFixed(2)}</p>
                `);
            }
        }

        // Limpar pedido
        function limparPedido() {
            if (confirm('Tem certeza que deseja cancelar este pedido?')) {
                itensPedido = [];
                atualizarListaItens();
                $('#pedidoForm')[0].reset();
                $('#resumoRapido').html('<p class="text-muted">Preencha as informações do pedido</p>');
            }
        }

        // Preparar formulário antes do envio
                    $('#pedidoForm').submit(function(e) {
            if (itensPedido.length === 0) {
                e.preventDefault();
                alert('Adicione pelo menos um item ao pedido');
                return;
            }

            // 🔧 Remove inputs antigos
            $(this).find('input[type="hidden"][name^="Itens"]').remove();

            // Adiciona novamente os atuais
            itensPedido.forEach((item, index) => {
                $(this).append(`
                    <input type="hidden" name="Itens[${index}].ProdutoId" value="${item.produtoId}">
                    <input type="hidden" name="Itens[${index}].ProdutoNome" value="${item.produtoNome}">
                    <input type="hidden" name="Itens[${index}].Quantidade" value="${item.quantidade}">
                    <input type="hidden" name="Itens[${index}].Observacoes" value="${item.observacoes || ''}">
                    <input type="hidden" name="Itens[${index}].Personalizacoes" value="${item.personalizacoes || ''}">
                `);
            });
        });

        

        // Atualizar taxa de entrega no resumo
        $('#TaxaEntrega').on('input', atualizarResumo);
    </script>
}