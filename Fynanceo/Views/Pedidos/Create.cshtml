
@using Fynanceo.ViewModel.PedidosModel
@model PedidoViewModel

@{
    ViewData["Title"] = "Novo Pedido";
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 mb-0">
        <i class="fas fa-plus-circle text-primary me-2"></i>@ViewData["Title"]
    </h1>
    <a href="@Url.Action("Index")" class="btn btn-outline-secondary">
        <i class="fas fa-arrow-left me-2"></i>Voltar
    </a>
</div>

<div class="row">
    <div class="col-md-8">
        <!-- Informações do Pedido -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Informações do Pedido</h5>
            </div>
            <div class="card-body">
                <form asp-action="Create" id="pedidoForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="TipoPedido" class="form-label">Tipo de Pedido *</label>
                                <select asp-for="TipoPedido" class="form-select" id="tipoPedidoSelect" required>
                                    <option value="">Selecione...</option>
                                  @* ///  <option value="1">Mesa</option> *@
                                    <option value="2">Balcão</option>
                                    <option value="3">Delivery</option>
                                </select>
                                <span asp-validation-for="TipoPedido" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3" id="mesaField" style="display: none;">
                                <label asp-for="MesaId" class="form-label">Mesa *</label>
                                <select asp-for="MesaId" class="form-select" asp-items="@(new SelectList(Model.MesasDisponiveis ?? new List<Fynanceo.Models.Mesa>(), "Id", "Numero"))">
                                    <option value="">Selecione a mesa...</option>
                                </select>
                                <span asp-validation-for="MesaId" class="text-danger"></span>
                            </div>
                            <div class="mb-3" id="clienteField" style="display: none;">
                                <label asp-for="ClienteId" class="form-label">Cliente *</label>
                                <select asp-for="ClienteId" class="form-select" id="clienteSelect">
                                    <option value="">Selecione o cliente...</option>
                                    @foreach (var cliente in Model.Clientes ?? new List<Fynanceo.Models.Cliente>())
                                    {
                                        <option value="@cliente.Id">@cliente.NomeCompleto</option>
                                    }
                                </select>
                                <span asp-validation-for="ClienteId" class="text-danger"></span>
                            </div>
                        </div>
                    </div>

                    <div class="row" id="deliveryFields" style="display: none;">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="EnderecoEntregaId" class="form-label">Endereço de Entrega</label>
                                <select asp-for="EnderecoEntregaId" class="form-select" id="enderecoSelect">
                                    <option value="">Selecione o endereço...</option>
                                </select>
                                <span asp-validation-for="EnderecoEntregaId" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="TaxaEntrega" class="form-label">Taxa de Entrega</label>
                                <input asp-for="TaxaEntrega" type="number" step="0.01" class="form-control" value="0" />
                                <span asp-validation-for="TaxaEntrega" class="text-danger"></span>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label asp-for="Observacoes" class="form-label">Observações</label>
                        <textarea asp-for="Observacoes" class="form-control" rows="3" placeholder="Observações especiais do pedido..."></textarea>
                        <span asp-validation-for="Observacoes" class="text-danger"></span>
                    </div>
                </form>
            </div>
        </div>

        <!-- Seção de Itens do Pedido -->
        <div class="card mt-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Itens do Pedido</h5>
                <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#produtoModal">
                    <i class="fas fa-plus me-1"></i>Adicionar Item
                </button>
            </div>
            <div class="card-body">
                <div id="itensPedido">
                    <div class="text-center text-muted py-4" id="emptyMessage">
                        <i class="fas fa-shopping-cart fa-2x mb-3"></i>
                        <p>Nenhum item adicionado ao pedido</p>
                    </div>
                </div>
                <div class="mt-4 pt-3 border-top" id="resumoPedido" style="display: none;">
                    <div class="row">
                        <div class="col-md-6">
                            <strong>Subtotal:</strong> <span id="subtotal">R$ 0,00</span><br>
                            <strong>Taxa de Entrega:</strong> <span id="taxaEntrega">R$ 0,00</span>
                        </div>
                        <div class="col-md-6 text-end">
                            <h4>Total: <span id="totalPedido">R$ 0,00</span></h4>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Coluna Resumo e Produtos Rápidos -->
    <div class="col-md-4">
        <!-- Resumo Rápido -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Resumo do Pedido</h5>
            </div>
            <div class="card-body">
                <div id="resumoRapido">
                    <p class="text-muted">Preencha as informações do pedido</p>
                </div>
                <div class="d-grid gap-2 mt-3">
                    <button type="submit" form="pedidoForm" class="btn btn-success btn-lg">
                        <i class="fas fa-check me-2"></i>Abrir Pedido
                    </button>
                    <button type="button" class="btn btn-outline-danger" onclick="limparPedido()">
                        <i class="fas fa-times me-2"></i>Cancelar
                    </button>
                </div>
            </div>
        </div>

        <!-- Produtos Populares -->
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0">Produtos Populares</h5>
            </div>
            <div class="card-body">
                <div class="list-group list-group-flush">
                    @foreach (var produto in Model.ProdutosDisponiveis?.Take(5) ?? new List<Fynanceo.Models.Produto>())
                    {
                        <button type="button" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                                onclick="adicionarProdutoRapido(@produto.Id, '@produto.Nome', @produto.ValorVenda)">
                            <div>
                                <strong>@produto.Nome</strong><br>
                                <small class="text-muted">R$ @produto.ValorVenda.ToString("N2")</small>
                            </div>
                            <span class="badge bg-primary rounded-pill">
                                <i class="fas fa-plus"></i>
                            </span>
                        </button>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Produtos (AJAX + Paginado + Scroll Infinito + Filtros) -->
<div class="modal fade" id="produtoModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Adicionar Produto</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <input type="text" class="form-control" id="searchProduto"
                           placeholder="Buscar produto por nome, categoria...">
                </div>

                <!-- Filtros Rápidos -->
                <div class="mb-3">
                    <div class="btn-group btn-group-sm" role="group" id="filtrosCategorias">
                        <button type="button" class="btn btn-outline-secondary active" data-categoria="">Todos</button>
                        @foreach (var categoria in Model.CategoriasDisponiveis?.Take(6) ?? new List<string>())
                        {
                            <button type="button" class="btn btn-outline-secondary" data-categoria="@categoria">@categoria</button>
                        }
                    </div>
                </div>

                <!-- Lista de Produtos -->
                <div class="row" id="listaProdutos" style="max-height: 400px; overflow-y: auto;">
                    <!-- Produtos carregados via AJAX -->
                </div>

                <!-- Loading -->
                <div id="loadingProdutos" class="text-center py-3" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Carregando...</span>
                    </div>
                    <p class="mt-2 text-muted">Carregando produtos...</p>
                </div>

                <!-- Sem resultados -->
                <div id="noResults" class="text-center py-4" style="display: none;">
                    <i class="fas fa-search fa-2x text-muted mb-3"></i>
                    <p class="text-muted">Nenhum produto encontrado</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Quantidade e Observações -->
<div class="modal fade" id="quantidadeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="quantidadeModalTitle">Adicionar Produto</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="produtoSelecionadoId">
                <input type="hidden" id="produtoSelecionadoNome">
                <input type="hidden" id="produtoSelecionadoPreco">

                <div class="mb-3">
                    <label class="form-label">Quantidade</label>
                    <input type="number" class="form-control" id="quantidadeProduto" value="1" min="0.1" step="0.1">
                </div>

                <div class="mb-3">
                    <label class="form-label">Observações</label>
                    <textarea class="form-control" id="observacoesProduto" rows="2" placeholder="Ex: Sem cebola, ponto da carne etc."></textarea>
                </div>

                <div class="mb-3">
                    <label class="form-label">Personalizações</label>
                    <textarea class="form-control" id="personalizacoesProduto" rows="2" placeholder="Ex: Borda recheada, extra bacon etc."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="adicionarItemPedido()">Adicionar</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // ===== Estado global da view =====
        let itensPedido = [];
        let currentProduto = null;

        // ===== Variáveis para paginação AJAX =====
        let currentPage = 1;
        const pageSize = 20;
        let isLoading = false;
        let hasMore = true;
        let currentSearch = '';
        let currentCategoria = '';

        // ===== Tipo de pedido (exibe campos) =====
        $('#tipoPedidoSelect').change(function() {
            const tipo = $(this).val();
            $('#mesaField, #clienteField, #deliveryFields').hide();
            $('#MesaId, #ClienteId').val('');
            switch(tipo) {
                case '1': $('#mesaField').show(); break;
                case '2': $('#clienteField').show(); break;
                case '3': $('#clienteField, #deliveryFields').show(); break;
            }
            atualizarResumo();
        });

        // ===== Endereços do cliente (AJAX) =====
        $('#clienteSelect').change(function() {
            const clienteId = $(this).val();
            if (!clienteId) return;
            $.get('/Pedidos/GetEnderecosCliente?clienteId=' + clienteId, function(data) {
                const select = $('#enderecoSelect');
                select.empty().append('<option value="">Selecione o endereço...</option>');
                data.forEach(endereco => {
                    select.append(`<option value="${endereco.id}">${endereco.enderecoCompleto}</option>`);
                });
            });
        });

        // ===== Selecionar produto (abre modal quantidade) =====
        function selecionarProduto(id, nome, preco) {
            currentProduto = { id, nome, preco };
            $('#produtoSelecionadoId').val(id);
            $('#produtoSelecionadoNome').val(nome);
            $('#produtoSelecionadoPreco').val(preco);
            $('#quantidadeModalTitle').text(`Adicionar ${nome}`);
            $('#quantidadeProduto').val(1);
            $('#observacoesProduto').val('');
            $('#personalizacoesProduto').val('');
            $('#produtoModal').modal('hide');
            $('#quantidadeModal').modal('show');
        }

        function adicionarProdutoRapido(id, nome, preco) {
            selecionarProduto(id, nome, preco);
        }

        // ===== Adicionar item ao pedido =====
        function adicionarItemPedido() {
            const quantidade = parseFloat($('#quantidadeProduto').val());
            if (quantidade <= 0) { alert('Quantidade deve ser maior que zero'); return; }
            const precoUnitario = parseFloat($('#produtoSelecionadoPreco').val()) || currentProduto?.preco || 0;
            const item = {
                produtoId: $('#produtoSelecionadoId').val() || currentProduto.id,
                produtoNome: $('#produtoSelecionadoNome').val() || currentProduto.nome,
                precoUnitario: precoUnitario,
                quantidade: quantidade,
                observacoes: $('#observacoesProduto').val(),
                personalizacoes: $('#personalizacoesProduto').val(),
                total: quantidade * precoUnitario
            };
            itensPedido.push(item);
            atualizarListaItens();
            $('#quantidadeModal').modal('hide');
        }

        // ===== Atualizar lista de itens (UI) =====
        function atualizarListaItens() {
            const container = $('#itensPedido');
            const emptyMessage = $('#emptyMessage');
            const resumoPedido = $('#resumoPedido');
            if (itensPedido.length === 0) {
                emptyMessage.show();
                resumoPedido.hide();
                container.find('.item-pedido').remove();
                return;
            }
            emptyMessage.hide();
            resumoPedido.show();
            container.find('.item-pedido').remove();
            itensPedido.forEach((item, index) => {
                container.append(`
                    <div class="item-pedido border-bottom pb-3 mb-3">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <h6 class="mb-1">${item.produtoNome}</h6>
                                <div class="text-muted small">
                                    ${item.quantidade} x R$ ${item.precoUnitario.toFixed(2)} = R$ ${item.total.toFixed(2)}
                                    ${item.observacoes ? `<br><strong>Obs:</strong> ${item.observacoes}` : ''}
                                    ${item.personalizacoes ? `<br><strong>Personalizações:</strong> ${item.personalizacoes}` : ''}
                                </div>
                            </div>
                            <button type="button" class="btn btn-sm btn-outline-danger ms-2" onclick="removerItem(${index})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `);
            });
            atualizarResumo();
        }

        function removerItem(index) {
            itensPedido.splice(index, 1);
            atualizarListaItens();
        }

        // ===== Atualizar resumo (subtotal, taxa, total) =====
        function atualizarResumo() {
            const subtotal = itensPedido.reduce((sum, i) => sum + i.total, 0);
            const taxaEntrega = parseFloat($('#TaxaEntrega').val()) || 0;
            const total = subtotal + taxaEntrega;
            $('#subtotal').text(`R$ ${subtotal.toFixed(2)}`);
            $('#taxaEntrega').text(`R$ ${taxaEntrega.toFixed(2)}`);
            $('#totalPedido').text(`R$ ${total.toFixed(2)}`);

            const resumoRapido = $('#resumoRapido');
            if (itensPedido.length > 0) {
                resumoRapido.html(`
                    <p><strong>Itens:</strong> ${itensPedido.length}</p>
                    <p><strong>Subtotal:</strong> R$ ${subtotal.toFixed(2)}</p>
                    <p><strong>Taxa:</strong> R$ ${taxaEntrega.toFixed(2)}</p>
                    <p><strong>Total:</strong> R$ ${total.toFixed(2)}</p>
                `);
            } else {
                resumoRapido.html('<p class="text-muted">Preencha as informações do pedido</p>');
            }
        }

        // ===== Limpar pedido =====
        function limparPedido() {
            if (!confirm('Tem certeza que deseja cancelar este pedido?')) return;
            itensPedido = [];
            atualizarListaItens();
            $('#pedidoForm')[0].reset();
            $('#resumoRapido').html('<p class="text-muted">Preencha as informações do pedido</p>');
        }

        // ===== Submissão do form =====
        $('#pedidoForm').submit(function(e) {
            if (itensPedido.length === 0) {
                e.preventDefault();
                alert('Adicione pelo menos um item ao pedido');
                return;
            }
            // Remove inputs escondidos antigos (se houver)
            $(this).find('input[type="hidden"][name^="Itens"]').remove();
            itensPedido.forEach((item, index) => {
                $(this).append(`
                    <input type="hidden" name="Itens[${index}].ProdutoId" value="${item.produtoId}">
                    <input type="hidden" name="Itens[${index}].ProdutoNome" value="${item.produtoNome}">
                    <input type="hidden" name="Itens[${index}].Quantidade" value="${item.quantidade}">
                    <input type="hidden" name="Itens[${index}].Observacoes" value="${item.observacoes || ''}">
                    <input type="hidden" name="Itens[${index}].Personalizacoes" value="${item.personalizacoes || ''}">
                `);
            });
        });

        // ===== Taxa entrega input - atualiza resumo =====
        $('#TaxaEntrega').on('input', atualizarResumo);

        // ======= AJAX: carregar produtos paginados =======
        function carregarProdutos(page = 1, search = '', categoria = '') {
            if (isLoading) return;

            isLoading = true;
            $('#loadingProdutos').show();
            $('#noResults').hide();

            $.get('/Pedidos/GetProdutosPaginados', {
                page: page,
                pageSize: pageSize,
                search: search,
                categoria: categoria
            }, function(data) {
                if (page === 1) {
                    $('#listaProdutos').empty();
                }

                if (!data || !data.produtos || data.produtos.length === 0) {
                    // sem resultados na primeira página
                    if (page === 1) {
                        $('#noResults').show();
                    }
                    hasMore = false;
                } else {
                    data.produtos.forEach(produto => {
                        // escapar apóstrofos no nome para inserir no onclick
                        const nomeEsc = (produto.nome || '').replace(/'/g, "\\'");
                        const produtoHtml = `
                            <div class="col-md-6 mb-3">
                                <div class="card h-100">
                                    <div class="card-body">
                                        <h6 class="card-title">${produto.nome}</h6>
                                        <p class="card-text text-muted small">${produto.subcategoria || ''}</p>
                                        <p class="card-text text-muted small">${produto.descricao || ''}</p>
                                        <div class="d-flex justify-content-between align-items-center">
                                            <strong class="text-primary">R$ ${parseFloat(produto.valorVenda).toFixed(2)}</strong>
                                            <button type="button" class="btn btn-sm btn-outline-primary"
                                                    onclick="selecionarProduto(${produto.id}, '${nomeEsc}', ${parseFloat(produto.valorVenda)})">
                                                <i class="fas fa-plus"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                        $('#listaProdutos').append(produtoHtml);
                    });

                    hasMore = page < data.totalPages;
                }

                currentPage = page;
                isLoading = false;
                $('#loadingProdutos').hide();
            }).fail(function() {
                // erro na requisição
                if (page === 1) {
                    $('#listaProdutos').empty();
                    $('#noResults').show();
                }
                isLoading = false;
                $('#loadingProdutos').hide();
            });
        }

        // ===== Scroll infinito no container de produtos (div com overflow) =====
        $('#listaProdutos').on('scroll', function() {
            const el = $(this)[0];
            if (!el) return;
            if (el.scrollTop + el.clientHeight >= el.scrollHeight - 100) {
                if (hasMore && !isLoading) {
                    carregarProdutos(currentPage + 1, currentSearch, currentCategoria);
                }
            }
        });

        // ===== Busca com debounce (input do modal) =====
        let searchTimeout;
        $('#searchProduto').on('input', function() {
            clearTimeout(searchTimeout);
            const termo = $(this).val().trim();
            searchTimeout = setTimeout(() => {
                currentSearch = termo;
                currentPage = 1;
                hasMore = true;
                carregarProdutos(1, currentSearch, currentCategoria);
            }, 500);
        });

        // ===== Filtro rápido por categoria =====
        $('#filtrosCategorias').on('click', 'button', function() {
            $('#filtrosCategorias button').removeClass('active');
            $(this).addClass('active');
            currentCategoria = $(this).data('categoria') || '';
            currentPage = 1;
            hasMore = true;
            carregarProdutos(1, currentSearch, currentCategoria);
        });

        // ===== Ao abrir o modal, carregar produtos (primeira página) =====
        $('#produtoModal').on('show.bs.modal', function () {
            // reset filtros de busca apenas no primeiro carregamento opcional
            // Caso queira manter últimos termos, comente as linhas abaixo.
            //$('#searchProduto').val('');
            //currentSearch = '';
            //currentCategoria = '';
            currentPage = 1;
            hasMore = true;
            carregarProdutos(1, currentSearch, currentCategoria);
        });

        // ===== Inicialização: caso queira pré-carregar produtos ao carregar a página (opcional) =====
        // Não pré-carrego para economizar requisições; o carregamento acontece ao abrir o modal.
    </script>
}
