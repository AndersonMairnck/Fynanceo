<!-- Página de detalhes de um pedido -->
@model Fynanceo.Models.Pedido

@using Fynanceo.Models.Enums;

@{
    // Define o título da página com o número do pedido
    ViewData["Title"] = $"Pedido {Model.NumeroPedido}";
}
<div class="container-fluid" data-pedido-id="@Model.Id"></div>
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 mb-0">
        <!-- Ícone + número do pedido -->
        <i class="fas fa-file-invoice text-primary me-2"></i>Pedido: @Model.NumeroPedido
    </h1>

    <div>
        <!-- Botão para voltar -->
        <a href="@Url.Action("Index")" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i>Voltar
        </a>

        <!-- Botão Editar só aparece se o pedido não estiver fechado -->
        @if (Model.Status != PedidoStatus.Fechado)
        {
            <a href="@Url.Action("Edit", new { id = Model.Id })" class="btn btn-primary">
                <i class="fas fa-edit me-2"></i>Editar
            </a>
        }
    </div>
</div>

<div class="row">
    <div class="col-md-8">

        <!-- ==========================================
             CARD: INFORMAÇÕES DO PEDIDO
        ========================================== -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Informações do Pedido</h5>

                <!-- Badge colorida conforme Status -->
                <div>
                    @{
                        // Prepara classes e textos visuais para o status do pedido
                        var statusClass = "";
                        var statusText = "";
                        switch (Model.Status)
                        {
                            case PedidoStatus.Aberto:
                                statusClass = "status-aberto";
                                statusText = "Aberto";
                                break;
                            case PedidoStatus.EnviadoCozinha:
                                statusClass = "status-cozinha";
                                statusText = "Enviado à Cozinha";
                                break;
                            case PedidoStatus.EmPreparo:
                                statusClass = "status-preparo";
                                statusText = "Em Preparo";
                                break;
                            case PedidoStatus.Pronto:
                                statusClass = "status-pronto";
                                statusText = "Pronto";
                                break;
                            case PedidoStatus.Entregue:
                                statusClass = "status-entregue";
                                statusText = "Entregue";
                                break;
                            case PedidoStatus.Fechado:
                                statusClass = "status-fechado";
                                statusText = "Fechado";
                                break;
                        }
                    }

                    <!-- Exibe o status do pedido -->
                    <span class="status-badge @statusClass">@statusText</span>
                </div>
            </div>

            <div class="card-body">
                <div class="row">

                    <!-- === Coluna esquerda: Informações básicas === -->
                    <div class="col-md-6">
                        <table class="table table-borderless">

                            <!-- Número -->
                            <tr>
                                <th width="40%">Número:</th>
                                <td>@Model.NumeroPedido</td>
                            </tr>

                            <!-- Tipo de pedido -->
                            <tr>
                                <th>Tipo:</th>
                                <td>
                                    @switch (Model.TipoPedido)
                                    {
                                        case TipoPedido.Mesa:
                                            <span class="badge bg-info">Mesa</span>
                                            break;
                                        case TipoPedido.Balcao:
                                            <span class="badge bg-secondary">Balcão</span>
                                            break;
                                        case TipoPedido.Delivery:
                                            <span class="badge bg-warning text-dark">Delivery</span>
                                            break;
                                    }
                                </td>
                            </tr>

                            <!-- Data abertura -->
                            <tr>
                                <th>Data Abertura:</th>
                                <td>@Model.DataAbertura.ToLocalTime()</td>
                            </tr>
                        </table>
                    </div>

                    <!-- === Coluna direita: Cliente/Mesa, atendente, etc === -->
                    <div class="col-md-6">
                        <table class="table table-borderless">

                            <!-- Exibe conforme tipo do pedido -->
                            <tr>
                                <th width="40%">Cliente/Mesa:</th>
                                <td>
                                    @if (Model.TipoPedido == TipoPedido.Mesa && Model.Mesa != null)
                                    {
                                        <!-- Pedido feito em mesa -->
                                        <text>Mesa @Model.Mesa.Numero - @Model.Mesa.Ambiente</text>
                                    }
                                    else if (Model.TipoPedido == TipoPedido.Delivery && Model.Cliente != null)
                                    {
                                        <!-- Pedido delivery -->
                                        <text>@Model.Cliente.NomeCompleto</text>
                                        <br>
                                        <small class="text-muted">@Model.EnderecoEntrega.Logradouro</small>
                                    }
                                    else
                                    {
                                        <!-- Pedido balcão -->
                                        <text>Balcão</text>
                                    }
                                </td>
                            </tr>

                            <!-- Atendente -->
                            <tr>
                                <th>Atendente:</th>
                                <td>@(Model.Funcionario?.NomeCompleto ?? "Sistema")</td>
                            </tr>

                            <!-- Prioridade -->
                            <tr>
                                <th>Prioridade:</th>
                                <td>
                                    @switch (Model.Prioridade)
                                    {
                                        case PrioridadePedido.Normal:
                                            <span class="badge bg-secondary">Normal</span>
                                            break;
                                        case PrioridadePedido.Urgente:
                                            <span class="badge bg-danger">Urgente</span>
                                            break;
                                        case PrioridadePedido.AguardandoConfirmacao:
                                            <span class="badge bg-warning text-dark">Aguardando</span>
                                            break;
                                    }
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>

                <!-- Observações do pedido -->
                @if (!string.IsNullOrEmpty(Model.Observacoes))
                {
                    <div class="mt-3 bg-info">
                        <strong><i class="fas fa-info-circle me-2"></i>Observações:</strong>
                        @Model.Observacoes
                    </div>
                }
            </div>
        </div>

        <!-- ==========================================
             CARD: ITENS DO PEDIDO
        ========================================== -->
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0">Itens do Pedido</h5>
            </div>

            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">

                        <thead>
                        <tr>
                            <th>Produto</th>
                            <th width="100" class="text-center">Quantidade</th>
                            <th width="120" class="text-end">Unitário</th>
                            <th width="120" class="text-end">Total</th>
                            <th width="100" class="text-center">Status</th>
                        </tr>
                        </thead>

                        <tbody>
                        @foreach (var item in Model.Itens)
                        {
                            var isProdutoPronto = item.Produto?.TempoPreparoMinutos == 0;
                            var badgeClass = item.Status == PedidoStatus.Aberto ? "secondary" :
                                item.Status == PedidoStatus.EnviadoCozinha ? "warning" :
                                item.Status == PedidoStatus.EmPreparo ? "info" :
                                item.Status == PedidoStatus.Pronto ? "success" :
                                item.Status == PedidoStatus.Entregue ? "primary" :
                                item.Status == PedidoStatus.Cancelado ? "danger" : "secondary";

                            <tr data-item-id="@item.Id"
                                class="@(isProdutoPronto ? "table-success" : "") @(item.Status == PedidoStatus.Cancelado ? "cancelado" : "")">
                                <td>
                                    <div>
                                        <strong>@item.Produto.Nome</strong>
                                        @if (isProdutoPronto)
                                        {
                                            <span class="badge bg-success ms-1" title="Produto Pronto">
                                                            <i class="fas fa-bolt"></i>
                                                        </span>
                                        }
                                        @if (!string.IsNullOrEmpty(item.Observacoes))
                                        {
                                            <br>
                                            <small class="text-muted">@item.Observacoes</small>
                                        }
                                    </div>
                                </td>
                                <td>@item.Quantidade</td>
                                <td>R$ @item.PrecoUnitario.ToString("N2")</td>
                                <td>R$ @item.Total.ToString("N2")</td>
                                <td>
                                                <span class="badge bg-@badgeClass status-item">
                                                    @item.Status
                                                </span>
                                    @if (isProdutoPronto && item.Status == PedidoStatus.Aberto)
                                    {
                                        <br>
                                        <small class="text-success">
                                            <i class="fas fa-info-circle"></i> Pronto para servir
                                        </small>
                                    }
                                </td>
                                <td class="text-center">
                                    @if (item.Status == PedidoStatus.Cancelado)
                                    {
                                        <span class="badge bg-danger">Cancelado</span>
                                    }
                                    else if (item.Status == PedidoStatus.Aberto || item.Status == PedidoStatus.EnviadoCozinha)
                                    {
                                        <!-- Botão Cancelar Item -->
                                        <button class="btn btn-sm btn-outline-danger cancelar-item ms-1"
                                                data-item-id="@item.Id"
                                                title="Cancelar item">
                                            <i class="fas fa-ban"></i>
                                        </button>

                                        @if (item.Status == PedidoStatus.Aberto && !isProdutoPronto)
                                        {
                                            <button class="btn btn-sm btn-warning enviar-item-cozinha"
                                                    data-item-id="@item.Id"
                                                    title="Enviar para cozinha">
                                                <i class="fas fa-utensils"></i>
                                            </button>
                                        }
                                        else if (item.Status == PedidoStatus.Aberto && isProdutoPronto)
                                        {
                                            <button class="btn btn-sm btn-success marcar-entregue"
                                                    data-item-id="@item.Id"
                                                    title="Marcar como entregue">
                                                <i class="fas fa-check"></i>
                                            </button>
                                        }
                                    }
                                    else if (item.Status == PedidoStatus.Pronto)
                                    {
                                        <button class="btn btn-sm btn-success marcar-entregue"
                                                data-item-id="@item.Id"
                                                title="Marcar como entregue">
                                            <i class="fas fa-check"></i>
                                        </button>
                                    }
                                    else
                                    {
                                        <span class="text-muted">-</span>
                                    }
                                </td>
                            </tr>
                        }
                        </tbody>

                       

                        <tfoot>
                        <!-- Subtotal -->
                        <tr>
                            <th colspan="3" class="text-end">Subtotal:</th>
                            <th class="text-end">R$ @Model.Subtotal.ToString("N2")</th>
                            <td></td>
                        </tr>

                        <!-- Taxa de entrega (se houver) -->
                        @if (Model.TaxaEntrega > 0)
                        {
                            <tr>
                                <th colspan="3" class="text-end">Taxa de Entrega:</th>
                                <th class="text-end">R$ @Model.TaxaEntrega.ToString("N2")</th>
                                <td></td>
                            </tr>
                        }

                        <!-- Total geral -->
                        <tr>
                            <th colspan="3" class="text-end">Total:</th>
                            <th class="text-end">R$ @Model.Total.ToString("N2")</th>
                            <td></td>
                        </tr>
                        </tfoot>

                    </table>
                </div>
            </div>
        </div>

        <!-- ==========================================
             CARD: HISTÓRICO DO PEDIDO
        ========================================== -->
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0">Histórico do Pedido</h5>
            </div>

            <div class="card-body">
                <div class="timeline">

                    <!-- Lista o histórico ordenado pelo horário -->
                    @foreach (var historico in Model.Historico.OrderBy(h => h.DataAlteracao))
                    {
                        <div class="timeline-item mb-3">
                            <div class="d-flex">

                                <!-- Marcador da timeline -->
                                <div class="timeline-marker bg-primary rounded-circle"
                                     style="width: 12px; height: 12px; margin-top: 5px;"></div>

                                <div class="ms-3">

                                    <!-- Status novo e horário -->
                                    <div class="d-flex justify-content-between">
                                        <strong>@historico.StatusNovo</strong>
                                        <small class="text-muted">@historico.DataAlteracao.ToLocalTime()</small>
                                    </div>

                                    <!-- Texto: De X para Y -->
                                    <small class="text-muted">
                                        De <strong>@historico.StatusAnterior</strong> para
                                        <strong>@historico.StatusNovo</strong>
                                        por @historico.UsuarioNome
                                    </small>

                                    <!-- Observação do histórico -->
                                    @if (!string.IsNullOrEmpty(historico.Observacao))
                                    {
                                        <div class="mt-1">
                                            <small>@historico.Observacao</small>
                                        </div>
                                    }

                                </div>

                            </div>
                        </div>
                    }

                </div>
            </div>
        </div>

    </div>

    <!-- ==========================================
         COLUNA DA DIREITA: AÇÕES DO PEDIDO
    ========================================== -->
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Ações</h5>
            </div>

            <div class="card-body">

                <!-- Botões de ação mudam conforme o status atual -->
               
                @if (Model.TipoPedido == TipoPedido.Delivery)
                {
                    @* Verifica se existe pelo menos um item com tempo de preparo *@
                    @if (Model.Itens.Any(i => i.Produto.TempoPreparoMinutos > 0))
                    {
                        @if (Model.Status == PedidoStatus.Aberto)
                        {
                            <button class="btn btn-warning w-100 mb-2" onclick="atualizarStatus('EnviadoCozinha')">
                                <i class="fas fa-paper-plane me-2"></i>Enviar para Cozinha
                            </button>
                        }
                        else if (Model.Status == PedidoStatus.Entregue)
                        {
                            @* <button class="btn btn-secondary w-100 mb-2" onclick="atualizarStatus('Fechado')"> *@
                            @*     <i class="fas fa-flag-checkered me-2"></i>Finalizar Pedido *@
                            @* </button> *@
                            
                            <a href="@Url.Action("FecharComPagamento", new { id = Model.Id })" 
                               class="btn btn-success w-100 mb-2">
                                <i class="fas fa-cash-register me-2"></i>Fechar e Registrar Pagamento
                            </a>
                        }
                       
                    }
                    else
                    {
                        
                            @if (Model.Status == PedidoStatus.Aberto)
                        {
                            <button class="btn btn-secondary w-100 mb-2"
                                    onclick="enviaParaEntrega(@Model.Id, '@Model.NumeroPedido','Pronto')">
                                <i class="fas fa-flag-checkered me-2"></i>Produtos Prontos Enviar Para Entrega
                            </button>
                        }
                            else if (Model.Status == PedidoStatus.Entregue)
                        {
                            @* <button class="btn btn-secondary w-100 mb-2" onclick="atualizarStatus('Fechado')"> *@
                            @*     <i class="fas fa-flag-checkered me-2"></i>Finalizar Pedido *@
                            @* </button> *@
                            <a href="@Url.Action("FecharComPagamento", new { id = Model.Id })" 
                               class="btn btn-success w-100 mb-2">
                                <i class="fas fa-cash-register me-2"></i>Fechar e Registrar Pagamento
                            </a>
                        }
                    }
                }
                else
                {
                    @if (Model.Status == PedidoStatus.Aberto)
                    {
                        <button class="btn btn-warning w-100 mb-2" onclick="atualizarStatus('EnviadoCozinha')">
                            <i class="fas fa-paper-plane me-2"></i>Enviar para Cozinha
                        </button>
                    }
                    else if (Model.Status == PedidoStatus.Pronto)
                    {
                        <button class="btn btn-info w-100 mb-2" onclick="atualizarStatus('Entregue')">
                            <i class="fas fa-truck me-2"></i>Marcar como Entregue
                        </button>
                    }
                    else if (Model.Status == PedidoStatus.EmRota)
                    {
                        <button class="btn btn-info w-100 mb-2" onclick="atualizarStatus('Entregue')">
                            <i class="fas fa-truck me-2"></i>Marcar como Entregue
                        </button>
                    }
                    else if (Model.Status == PedidoStatus.Entregue)
                    {
                        <a href="@Url.Action("FecharComPagamento", new { id = Model.Id })" 
                           class="btn btn-success w-100 mb-2">
                            <i class="fas fa-cash-register me-2"></i>Fechar e Registrar Pagamento
                        </a>
                    }
                }
                
               @if (Model.TipoPedido == TipoPedido.Balcao)
                {
                    @* Verifica se existe pelo menos um item com tempo de preparo *@
                    @if (Model.Itens.Any(i => i.Produto.TempoPreparoMinutos > 0))
                    {
                        @if (Model.Status == PedidoStatus.Aberto)
                        {
                         
                        }
                        else if (Model.Status == PedidoStatus.Entregue)
                        {
                        
                            <a href="@Url.Action("FecharComPagamento", new { id = Model.Id })" 
                               class="btn btn-success w-100 mb-2">
                                <i class="fas fa-cash-register me-2"></i>Fechar e Registrar Pagamento
                            </a>
                        }
                       
                    }
                    else
                    {
                        
                            @if (Model.Status == PedidoStatus.Aberto)
                        {
                            <button class="btn btn-secondary w-100 mb-2"
                                    onclick="enviaParaEntrega(@Model.Id, '@Model.NumeroPedido','Pronto')">
                                <i class="fas fa-flag-checkered me-2"></i>Produtos Prontos Enviar Para Entrega
                            </button>
                        }
                            else if (Model.Status == PedidoStatus.Entregue)
                        {
                         
                            <a href="@Url.Action("FecharComPagamento", new { id = Model.Id })" 
                               class="btn btn-success w-100 mb-2">
                                <i class="fas fa-cash-register me-2"></i>Fechar e Registrar Pagamento
                            </a>
                        }
                    }
                }

                <!-- Botão cancelar aparece em qualquer status não fechado -->
                @if (Model.Status != PedidoStatus.Fechado)
                {
                    <button class="btn btn-outline-danger w-100" onclick="atualizarStatus('Cancelado')">
                        <i class="fas fa-times me-2"></i>Cancelar Pedido
                    </button>
                }

                <hr>

                <!-- Botões auxiliares -->
                <div class="d-grid gap-2">
                    <a href="#" class="btn btn-outline-primary">
                        <i class="fas fa-print me-2"></i>Imprimir Comanda
                    </a>
                    <a href="#" class="btn btn-outline-secondary">
                        <i class="fas fa-receipt me-2"></i>Gerar Conta
                    </a>
                </div>
            </div>
        </div>

        <!-- ------------------------------------------
             CARD: INFORMAÇÕES DE TEMPO
        ------------------------------------------- -->
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0">Tempos</h5>
            </div>

            <div class="card-body">
                <table class="table table-sm table-borderless">

                    <!-- Data de abertura -->
                    <tr>
                        <td><small>Abertura:</small></td>
                        <td class="text-end"><small>@Model.DataAbertura.ToLocalTime()</small></td>
                    </tr>

                    <!-- Exibe tempos somente se existirem -->
                    @if (Model.DataEnvioCozinha.HasValue)
                    {
                        <tr>
                            <td><small>Envio Cozinha:</small></td>
                            <td class="text-end"><small>@Model.DataEnvioCozinha.Value.ToLocalTime()</small></td>
                        </tr>
                    }

                    @if (Model.DataPreparo.HasValue)
                    {
                        <tr>
                            <td><small>Início Preparo:</small></td>
                            <td class="text-end"><small>@Model.DataPreparo.Value.ToLocalTime()</small></td>
                        </tr>
                    }

                    @if (Model.DataPronto.HasValue)
                    {
                        <tr>
                            <td><small>Pronto:</small></td>
                            <td class="text-end"><small>@Model.DataPronto.Value.ToLocalTime()</small></td>
                        </tr>
                    }

                    @if (Model.DataEntrega.HasValue)
                    {
                        <tr>
                            <td><small>Entrega:</small></td>
                            <td class="text-end"><small>@Model.DataEntrega.Value.ToLocalTime()</small></td>
                        </tr>
                    }

                </table>

                <!-- Tempo total decorrido -->
                <div class="text-center mt-3">
                    @{
                        var tempoTotal = DateTime.Now - Model.DataAbertura.ToLocalTime();
                        <h4 class="text-primary">@((int)tempoTotal.TotalMinutes)m</h4>
                        <small class="text-muted">Tempo decorrido</small>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript responsável por atualizar status do pedido -->

<script>
    var pedidoId = '@Model.Id';
</script>
<script src="~/js/Pedidos/Pedidos.js"></script>

