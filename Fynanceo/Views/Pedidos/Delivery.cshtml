
@using Fynanceo.Models.Enums
@model Fynanceo.ViewModel.PedidosModel.PedidoViewModel

@{
    ViewData["Title"] = "Novo Pedido - Delivery";
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 mb-0">
        <i class="fas fa-motorcycle text-primary me-2"></i>@ViewData["Title"]
    </h1>
    <a href="@Url.Action("Index")" class="btn btn-outline-secondary">
        <i class="fas fa-arrow-left me-2"></i>Voltar
    </a>
</div>

<div class="row">
    <div class="col-md-8">
        <!-- Informações de Entrega -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-white">
                <h5 class="mb-0"><i class="fas fa-map-marker-alt text-danger me-2"></i>Dados da Entrega</h5>
            </div>
            <div class="card-body">
                <form asp-action="Delivery" id="pedidoForm">
                    <input type="hidden" asp-for="TipoPedido" value="@((int)TipoPedido.Delivery)" />
                    
                    <div class="row">
                        <div class="col-md-12">
                            <div class="mb-3">
                                <label asp-for="ClienteId" class="form-label">Cliente *</label>
                                <select asp-for="ClienteId" class="form-select select2" id="clienteSelect" required>
                                    <option value="">Selecione o cliente...</option>
                                    @foreach (var cliente in Model.Clientes ?? new List<Cliente>())
                                    {
                                        <option value="@cliente.Id">@cliente.NomeCompleto</option>
                                    }
                                </select>
                                <span asp-validation-for="ClienteId" class="text-danger"></span>
                            </div>
                        </div>
                    </div>

                    <div class="row" id="deliveryFields">
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label asp-for="EnderecoEntregaId" class="form-label">Endereço de Entrega *</label>
                                <select asp-for="EnderecoEntregaId" class="form-select" id="enderecoSelect" required>
                                    <option value="">Selecione o cliente primeiro...</option>
                                </select>
                                <span asp-validation-for="EnderecoEntregaId" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label asp-for="TaxaEntrega" class="form-label">Taxa de Entrega</label>
                                <div class="input-group">
                                    <span class="input-group-text">R$</span>
                                    <input asp-for="TaxaEntrega" type="number" step="0.01" class="form-control" id="taxaEntregaInput" value="0" />
                                </div>
                                <span asp-validation-for="TaxaEntrega" class="text-danger"></span>
                            </div>
                        </div>
                    </div>

                    <div class="mb-0">
                        <label asp-for="Observacoes" class="form-label">Observações do Pedido</label>
                        <textarea asp-for="Observacoes" class="form-control" rows="2" placeholder="Ponto da carne, troco para quanto, etc."></textarea>
                        <span asp-validation-for="Observacoes" class="text-danger"></span>
                    </div>
                </form>
            </div>
        </div>

        <!-- Itens do Pedido -->
        <div class="card shadow-sm mt-4">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Produtos Selecionados</h5>
                <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#produtoModal">
                    <i class="fas fa-search me-1"></i>Buscar Produto
                </button>
            </div>
            <div class="card-body">
                <div id="itensPedido">
                    <div class="text-center text-muted py-5" id="emptyMessage">
                        <i class="fas fa-shopping-basket fa-3x mb-3 opacity-25"></i>
                        <p>O carrinho está vazio</p>
                    </div>
                </div>
                
                <div class="mt-4 pt-3 border-top" id="resumoPedido" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center mb-2 text-muted">
                        <span>Subtotal Itens</span>
                        <span id="subtotal">R$ 0,00</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-3 text-muted">
                        <span>Taxa de Entrega</span>
                        <span id="taxaResumo">R$ 0,00</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <h4 class="mb-0">Total do Pedido</h4>
                        <h4 class="mb-0 text-primary fw-bold" id="totalPedido">R$ 0,00</h4>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Coluna Lateral -->
    <div class="col-md-4">
        <!-- Card de Ação -->
        <div class="card shadow-sm sticky-top" style="top: 20px; z-index: 1000;">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Resumo da Entrega</h5>
            </div>
            <div class="card-body">
                <div id="resumoRapido" class="mb-3">
                    <p class="text-muted text-center py-2">Inicie o pedido selecionando um cliente e produtos</p>
                </div>
                <div class="d-grid gap-2">
                    <button type="submit" form="pedidoForm" class="btn btn-primary btn-lg shadow-sm">
                        <i class="fas fa-motorcycle me-2"></i>Enviar para Entrega
                    </button>
                    <button type="button" class="btn btn-link text-danger text-decoration-none" onclick="limparPedido()">
                        Cancelar Pedido
                    </button>
                </div>
            </div>
        </div>

        <!-- Produtos Sugeridos -->
        <div class="card shadow-sm mt-4">
            <div class="card-header bg-white">
                <h5 class="mb-0">Sugestões do Dia</h5>
            </div>
            <div class="card-body p-0">
                <div class="list-group list-group-flush">
                    @foreach (var produto in Model.ProdutosDisponiveis?.Take(5) ?? new List<Produto>())
                    {
                        <button type="button" class="list-group-item list-group-item-action d-flex align-items-center gap-3 py-3"
                                onclick="adicionarProdutoRapido(@produto.Id, '@produto.Nome', @produto.ValorVenda)">
                            <div class="bg-light rounded p-2 text-primary">
                                <i class="fas fa-utensils"></i>
                            </div>
                            <div class="flex-grow-1">
                                <span class="d-block fw-bold text-truncate" style="max-width: 150px;">@produto.Nome</span>
                                <small class="text-primary fw-bold">R$ @produto.ValorVenda.ToString("N2")</small>
                            </div>
                            <i class="fas fa-plus-circle text-muted"></i>
                        </button>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Busca de Produtos -->
<div class="modal fade" id="produtoModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content border-0">
            <div class="modal-header">
                <h5 class="modal-title">Adicionar ao Pedido</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-4">
                    <div class="input-group input-group-lg shadow-sm">
                        <span class="input-group-text bg-white border-end-0"><i class="fas fa-search"></i></span>
                        <input type="text" class="form-control border-start-0" id="searchProduto" placeholder="Busque por pratos, bebidas...">
                    </div>
                </div>

                <div class="mb-3 overflow-auto pb-2">
                    <div class="btn-group btn-group-sm" id="filtrosCategorias">
                        <button type="button" class="btn btn-outline-primary active" data-categoria="">Todos</button>
                        @foreach (var categoria in Model.CategoriasDisponiveis?.Take(10) ?? new List<string>())
                        {
                            <button type="button" class="btn btn-outline-primary" data-categoria="@categoria">@categoria</button>
                        }
                    </div>
                </div>

                <div class="row g-3" id="listaProdutos" style="max-height: 400px; overflow-y: auto;">
                    <!-- AJAX content -->
                </div>

                <div id="loadingProdutos" class="text-center py-5" style="display: none;">
                    <div class="spinner-border text-primary"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Quantidade/Opções -->
<div class="modal fade" id="quantidadeModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content shadow">
            <div class="modal-header border-0">
                <h5 class="modal-title fw-bold" id="quantidadeModalTitle">Item</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body pt-0">
                <input type="hidden" id="produtoSelecionadoId">
                <input type="hidden" id="produtoSelecionadoNome">
                <input type="hidden" id="produtoSelecionadoPreco">

                <div class="mb-4 text-center">
                    <p class="text-muted small mb-2">Selecione a quantidade</p>
                    <div class="d-flex justify-content-center align-items-center gap-3">
                        <button class="btn btn-outline-primary btn-lg rounded-circle" type="button" onclick="alterarQtd(-1)" style="width: 50px; height: 50px;">-</button>
                        <input type="number" class="form-control form-control-lg text-center fw-bold border-0" id="quantidadeProduto" value="1" min="1" style="width: 80px; font-size: 1.5rem;">
                        <button class="btn btn-outline-primary btn-lg rounded-circle" type="button" onclick="alterarQtd(1)" style="width: 50px; height: 50px;">+</button>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold small">Alguma observação?</label>
                    <textarea class="form-control bg-light border-0" id="observacoesProduto" rows="2" placeholder="Ex: Tirar cebola, pouco sal..."></textarea>
                </div>
                
                <div class="mb-3">
                    <label class="form-label fw-bold small">Personalizações</label>
                    <textarea class="form-control bg-light border-0" id="personalizacoesProduto" rows="2" placeholder="Ex: Borda de catupiry, extra queijo..."></textarea>
                </div>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-primary btn-lg w-100" onclick="adicionarItemPedido()">
                    Adicionar ao Pedido
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let itensPedido = [];
        let currentProduto = null;
        let currentPage = 1;
        const pageSize = 20;
        let isLoading = false;
        let hasMore = true;
        let currentSearch = '';
        let currentCategoria = '';

        function alterarQtd(val) {
            let input = $('#quantidadeProduto');
            let current = parseInt(input.val()) || 1;
            input.val(Math.max(1, current + val));
        }

        $('#clienteSelect').change(function() {
            const clienteId = $(this).val();
            if (!clienteId) {
                $('#enderecoSelect').empty().append('<option value="">Selecione o cliente primeiro...</option>');
                return;
            }
            $.get('/Pedidos/GetEnderecosCliente?clienteId=' + clienteId, function(data) {
                const select = $('#enderecoSelect');
                select.empty().append('<option value="">Selecione o endereço...</option>');
                data.forEach(e => select.append(`<option value="${e.id}">${e.enderecoCompleto}</option>`));
            });
        });

        function selecionarProduto(id, nome, preco) {
            currentProduto = { id, nome, preco };
            $('#produtoSelecionadoId').val(id);
            $('#produtoSelecionadoNome').val(nome);
            $('#produtoSelecionadoPreco').val(preco);
            $('#quantidadeModalTitle').text(nome);
            $('#quantidadeProduto').val(1);
            $('#observacoesProduto').val('');
            $('#personalizacoesProduto').val('');
            $('#produtoModal').modal('hide');
            $('#quantidadeModal').modal('show');
        }

        function adicionarProdutoRapido(id, nome, preco) {
            selecionarProduto(id, nome, preco);
        }

        function adicionarItemPedido() {
            const quantidade = parseFloat($('#quantidadeProduto').val());
            if (quantidade <= 0) return;
            
            const precoUnitario = parseFloat($('#produtoSelecionadoPreco').val());
            const item = {
                produtoId: $('#produtoSelecionadoId').val(),
                produtoNome: $('#produtoSelecionadoNome').val(),
                precoUnitario: precoUnitario,
                quantidade: quantidade,
                observacoes: $('#observacoesProduto').val(),
                personalizacoes: $('#personalizacoesProduto').val(),
                total: quantidade * precoUnitario
            };
            
            itensPedido.push(item);
            atualizarListaItens();
            $('#quantidadeModal').modal('hide');
        }

        function atualizarListaItens() {
            const container = $('#itensPedido');
            const emptyMessage = $('#emptyMessage');
            const resumoPedido = $('#resumoPedido');
            
            container.find('.item-pedido').remove();
            
            if (itensPedido.length === 0) {
                emptyMessage.show();
                resumoPedido.hide();
                return;
            }
            
            emptyMessage.hide();
            resumoPedido.show();
            
            itensPedido.forEach((item, index) => {
                container.append(`
                    <div class="item-pedido d-flex justify-content-between align-items-center mb-3 p-3 bg-light rounded shadow-sm">
                        <div class="flex-grow-1">
                            <div class="d-flex align-items-center gap-2 mb-1">
                                <span class="badge bg-primary rounded-pill">${item.quantidade}x</span>
                                <span class="fw-bold">${item.produtoNome}</span>
                            </div>
                            <small class="text-muted d-block">R$ ${item.precoUnitario.toFixed(2)} cada</small>
                            ${item.observacoes ? `<small class="text-danger d-block mt-1"><i class="fas fa-info-circle me-1"></i>${item.observacoes}</small>` : ''}
                        </div>
                        <div class="text-end">
                            <span class="d-block fw-bold text-primary mb-2">R$ ${item.total.toFixed(2)}</span>
                            <button type="button" class="btn btn-sm btn-outline-danger border-0" onclick="removerItem(${index})"><i class="fas fa-times"></i></button>
                        </div>
                    </div>
                `);
            });
            atualizarResumo();
        }

        function removerItem(index) {
            itensPedido.splice(index, 1);
            atualizarListaItens();
        }

        function atualizarResumo() {
            const subtotal = itensPedido.reduce((sum, i) => sum + i.total, 0);
            const taxa = parseFloat($('#taxaEntregaInput').val()) || 0;
            const total = subtotal + taxa;
            
            $('#subtotal').text(`R$ ${subtotal.toFixed(2)}`);
            $('#taxaResumo').text(`R$ ${taxa.toFixed(2)}`);
            $('#totalPedido').text(`R$ ${total.toFixed(2)}`);

            const resumoRapido = $('#resumoRapido');
            if (itensPedido.length > 0) {
                resumoRapido.html(`
                    <div class="card bg-light border-0">
                        <div class="card-body p-3">
                            <div class="d-flex justify-content-between mb-1 small">
                                <span>Itens (${itensPedido.length})</span>
                                <span>R$ ${subtotal.toFixed(2)}</span>
                            </div>
                            <div class="d-flex justify-content-between mb-2 small">
                                <span>Taxa</span>
                                <span>R$ ${taxa.toFixed(2)}</span>
                            </div>
                            <div class="d-flex justify-content-between h5 mb-0 fw-bold text-primary">
                                <span>Total</span>
                                <span>R$ ${total.toFixed(2)}</span>
                            </div>
                        </div>
                    </div>
                `);
            } else {
                resumoRapido.html('<p class="text-muted text-center py-2">Selecione produtos</p>');
            }
        }

        $('#taxaEntregaInput').on('input', atualizarResumo);

        function limparPedido() {
            if (!confirm('Deseja realmente cancelar?')) return;
            itensPedido = [];
            atualizarListaItens();
            $('#pedidoForm')[0].reset();
            $('#enderecoSelect').empty().append('<option value="">Selecione o cliente primeiro...</option>');
        }

        $('#pedidoForm').submit(function(e) {
            if (itensPedido.length === 0) {
                e.preventDefault();
                alert('O pedido não tem itens!');
                return;
            }
            $(this).find('input[type="hidden"][name^="Itens"]').remove();
            itensPedido.forEach((item, index) => {
                $(this).append(`
                    <input type="hidden" name="Itens[${index}].ProdutoId" value="${item.produtoId}">
                    <input type="hidden" name="Itens[${index}].ProdutoNome" value="${item.produtoNome}">
                    <input type="hidden" name="Itens[${index}].Quantidade" value="${item.quantidade}">
                    <input type="hidden" name="Itens[${index}].Observacoes" value="${item.observacoes || ''}">
                    <input type="hidden" name="Itens[${index}].Personalizacoes" value="${item.personalizacoes || ''}">
                `);
            });
        });

        function carregarProdutos(page = 1, search = '', categoria = '') {
            if (isLoading) return;
            isLoading = true;
            $('#loadingProdutos').show();

            $.get('/Pedidos/GetProdutosPaginados', {
                page: page,
                pageSize: pageSize,
                search: search,
                categoria: categoria
            }, function(data) {
                if (page === 1) $('#listaProdutos').empty();

                if (data && data.produtos) {
                    data.produtos.forEach(p => {
                        const nomeEsc = (p.nome || '').replace(/'/g, "\\'");
                        $('#listaProdutos').append(`
                            <div class="col-md-6">
                                <div class="card h-100 border-0 shadow-sm" onclick="selecionarProduto(${p.id}, '${nomeEsc}', ${parseFloat(p.valorVenda)})" style="cursor: pointer;">
                                    <div class="card-body d-flex justify-content-between align-items-center">
                                        <div>
                                            <h6 class="mb-0 fw-bold">${p.nome}</h6>
                                            <small class="text-muted">${p.categoria || ''}</small><br>
                                            <span class="text-primary fw-bold">R$ ${parseFloat(p.valorVenda).toFixed(2)}</span>
                                        </div>
                                        <div class="btn btn-sm btn-light rounded-circle text-primary"><i class="fas fa-plus"></i></div>
                                    </div>
                                </div>
                            </div>
                        `);
                    });
                    hasMore = page < data.totalPages;
                }
                currentPage = page;
                isLoading = false;
                $('#loadingProdutos').hide();
            });
        }

        $('#listaProdutos').on('scroll', function() {
            if (this.scrollTop + this.clientHeight >= this.scrollHeight - 20) {
                if (hasMore && !isLoading) carregarProdutos(currentPage + 1, currentSearch, currentCategoria);
            }
        });

        let searchTimeout;
        $('#searchProduto').on('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                currentSearch = $(this).val();
                currentPage = 1;
                carregarProdutos(1, currentSearch, currentCategoria);
            }, 400);
        });

        $('#filtrosCategorias').on('click', 'button', function() {
            $('#filtrosCategorias button').removeClass('active');
            $(this).addClass('active');
            currentCategoria = $(this).data('categoria') || '';
            currentPage = 1;
            carregarProdutos(1, currentSearch, currentCategoria);
        });

        $('#produtoModal').on('show.bs.modal', function () {
            carregarProdutos(1, currentSearch, currentCategoria);
        });
    </script>
}
