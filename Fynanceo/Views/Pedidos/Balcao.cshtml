
@using Fynanceo.ViewModel.PedidosModel
@using Fynanceo.Models.Enums
@model PedidoViewModel

@{
    ViewData["Title"] = "Novo Pedido - Balcão";
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 mb-0">
        <i class="fas fa-cash-register text-success me-2"></i>@ViewData["Title"]
    </h1>
    <a href="@Url.Action("Index")" class="btn btn-outline-secondary">
        <i class="fas fa-arrow-left me-2"></i>Voltar
    </a>
</div>

<div class="row">
    <div class="col-md-8">
        <!-- Informações do Pedido -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-white">
                <h5 class="mb-0">Informações do Cliente</h5>
            </div>
            <div class="card-body">
                <form asp-action="Balcao" id="pedidoForm">
                    <input type="hidden" asp-for="TipoPedido" value="@((int)TipoPedido.Balcao)" />
                    
                    <div class="row">
                        <div class="col-md-12">
                            <div class="mb-3">
                                <label asp-for="ClienteId" class="form-label">Cliente (Opcional)</label>
                                <select asp-for="ClienteId" class="form-select" id="clienteSelect">
                                    <option value="">Consumidor Final</option>
                                    @foreach (var cliente in Model.Clientes ?? new List<Cliente>())
                                    {
                                        <option value="@cliente.Id">@cliente.NomeCompleto</option>
                                    }
                                </select>
                                <span asp-validation-for="ClienteId" class="text-danger"></span>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label asp-for="Observacoes" class="form-label">Observações</label>
                        <textarea asp-for="Observacoes" class="form-control" rows="2" placeholder="Observações especiais do pedido..."></textarea>
                        <span asp-validation-for="Observacoes" class="text-danger"></span>
                    </div>
                </form>
            </div>
        </div>

        <!-- Seção de Itens do Pedido -->
        <div class="card shadow-sm mt-4">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Itens do Pedido</h5>
                <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#produtoModal">
                    <i class="fas fa-plus me-1"></i>Adicionar Item
                </button>
            </div>
            <div class="card-body">
                <div id="itensPedido">
                    <div class="text-center text-muted py-4" id="emptyMessage">
                        <i class="fas fa-shopping-cart fa-2x mb-3"></i>
                        <p>Nenhum item adicionado ao pedido</p>
                    </div>
                </div>
                <div class="mt-4 pt-3 border-top" id="resumoPedido" style="display: none;">
                    <div class="row">
                        <div class="col-md-6">
                            <strong>Subtotal:</strong> <span id="subtotal">R$ 0,00</span>
                        </div>
                        <div class="col-md-6 text-end">
                            <h4>Total: <span id="totalPedido" class="text-success">R$ 0,00</span></h4>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Coluna Resumo e Produtos Rápidos -->
    <div class="col-md-4">
        <!-- Resumo Rápido -->
        <div class="card shadow-sm sticky-top" style="top: 20px;">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">Finalizar Pedido</h5>
            </div>
            <div class="card-body">
                <div id="resumoRapido">
                    <p class="text-muted">Adicione produtos para continuar</p>
                </div>
                <div class="d-grid gap-2 mt-3">
                    <button type="submit" form="pedidoForm" class="btn btn-success btn-lg">
                        <i class="fas fa-check-circle me-2"></i>Concluir Venda
                    </button>
                    <button type="button" class="btn btn-outline-danger" onclick="limparPedido()">
                        <i class="fas fa-trash me-2"></i>Limpar
                    </button>
                </div>
            </div>
        </div>

        <!-- Produtos Populares -->
        <div class="card shadow-sm mt-4">
            <div class="card-header bg-white">
                <h5 class="mb-0"><i class="fas fa-star text-warning me-2"></i>Mais Vendidos</h5>
            </div>
            <div class="card-body p-0">
                <div class="list-group list-group-flush">
                    @foreach (var produto in Model.ProdutosDisponiveis?.Take(6) ?? new List<Produto>())
                    {
                        <button type="button" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center py-3"
                                onclick="adicionarProdutoRapido(@produto.Id, '@produto.Nome', @produto.ValorVenda)">
                            <div>
                                <strong class="d-block">@produto.Nome</strong>
                                <small class="text-success fw-bold">R$ @produto.ValorVenda.ToString("N2")</small>
                            </div>
                            <span class="btn btn-sm btn-light rounded-circle">
                                <i class="fas fa-plus text-primary"></i>
                            </span>
                        </button>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Produtos -->
<div class="modal fade" id="produtoModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-light">
                <h5 class="modal-title">Catálogo de Produtos</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="input-group mb-3">
                    <span class="input-group-text bg-white border-end-0">
                        <i class="fas fa-search text-muted"></i>
                    </span>
                    <input type="text" class="form-control border-start-0" id="searchProduto"
                           placeholder="Pesquisar por nome ou categoria...">
                </div>

                <!-- Filtros Rápidos -->
                <div class="mb-3 overflow-auto">
                    <div class="btn-group btn-group-sm" role="group" id="filtrosCategorias">
                        <button type="button" class="btn btn-outline-secondary active" data-categoria="">Todos</button>
                        @foreach (var categoria in Model.CategoriasDisponiveis?.Take(8) ?? new List<string>())
                        {
                            <button type="button" class="btn btn-outline-secondary" data-categoria="@categoria">@categoria</button>
                        }
                    </div>
                </div>

                <!-- Lista de Produtos -->
                <div class="row g-3" id="listaProdutos" style="max-height: 450px; overflow-y: auto;">
                    <!-- Carregado via AJAX -->
                </div>

                <!-- Loading -->
                <div id="loadingProdutos" class="text-center py-4" style="display: none;">
                    <div class="spinner-border text-primary" role="status"></div>
                </div>

                <!-- Sem resultados -->
                <div id="noResults" class="text-center py-4" style="display: none;">
                    <i class="fas fa-search fa-2x text-muted mb-2"></i>
                    <p class="text-muted">Nenhum produto encontrado</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Detalhes do Item -->
<div class="modal fade" id="quantidadeModal" tabindex="-1">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="quantidadeModalTitle">Item</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="produtoSelecionadoId">
                <input type="hidden" id="produtoSelecionadoNome">
                <input type="hidden" id="produtoSelecionadoPreco">

                <div class="mb-3 text-center">
                    <label class="form-label d-block fw-bold">Quantidade</label>
                    <div class="input-group">
                        <button class="btn btn-outline-secondary" type="button" onclick="alterarQtd(-1)">-</button>
                        <input type="number" class="form-control text-center fw-bold" id="quantidadeProduto" value="1" min="1" step="1">
                        <button class="btn btn-outline-secondary" type="button" onclick="alterarQtd(1)">+</button>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label small text-muted">Observações (opcional)</label>
                    <textarea class="form-control form-control-sm" id="observacoesProduto" rows="2"></textarea>
                </div>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-primary w-100" onclick="adicionarItemPedido()">
                    Confirmar Item
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let itensPedido = [];
        let currentProduto = null;
        let currentPage = 1;
        const pageSize = 20;
        let isLoading = false;
        let hasMore = true;
        let currentSearch = '';
        let currentCategoria = '';

        function alterarQtd(val) {
            let input = $('#quantidadeProduto');
            let current = parseInt(input.val()) || 1;
            input.val(Math.max(1, current + val));
        }

        function selecionarProduto(id, nome, preco) {
            currentProduto = { id, nome, preco };
            $('#produtoSelecionadoId').val(id);
            $('#produtoSelecionadoNome').val(nome);
            $('#produtoSelecionadoPreco').val(preco);
            $('#quantidadeModalTitle').text(nome);
            $('#quantidadeProduto').val(1);
            $('#observacoesProduto').val('');
            $('#produtoModal').modal('hide');
            $('#quantidadeModal').modal('show');
        }

        function adicionarProdutoRapido(id, nome, preco) {
            selecionarProduto(id, nome, preco);
        }

        function adicionarItemPedido() {
            const quantidade = parseFloat($('#quantidadeProduto').val());
            if (quantidade <= 0) return;
            
            const precoUnitario = parseFloat($('#produtoSelecionadoPreco').val());
            const item = {
                produtoId: $('#produtoSelecionadoId').val(),
                produtoNome: $('#produtoSelecionadoNome').val(),
                precoUnitario: precoUnitario,
                quantidade: quantidade,
                observacoes: $('#observacoesProduto').val(),
                total: quantidade * precoUnitario
            };
            
            itensPedido.push(item);
            atualizarListaItens();
            $('#quantidadeModal').modal('hide');
        }

        function atualizarListaItens() {
            const container = $('#itensPedido');
            const emptyMessage = $('#emptyMessage');
            const resumoPedido = $('#resumoPedido');
            
            container.find('.item-pedido').remove();
            
            if (itensPedido.length === 0) {
                emptyMessage.show();
                resumoPedido.hide();
                return;
            }
            
            emptyMessage.hide();
            resumoPedido.show();
            
            itensPedido.forEach((item, index) => {
                container.append(`
                    <div class="item-pedido border-bottom py-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <span class="badge bg-secondary me-2">${item.quantidade}x</span>
                                <span class="fw-bold">${item.produtoNome}</span>
                                ${item.observacoes ? `<br><small class="text-muted ms-4">Obs: ${item.observacoes}</small>` : ''}
                            </div>
                            <div class="text-end">
                                <span class="d-block fw-bold">R$ ${item.total.toFixed(2)}</span>
                                <button type="button" class="btn btn-link btn-sm text-danger p-0" onclick="removerItem(${index})">Remover</button>
                            </div>
                        </div>
                    </div>
                `);
            });
            atualizarResumo();
        }

        function removerItem(index) {
            itensPedido.splice(index, 1);
            atualizarListaItens();
        }

        function atualizarResumo() {
            const total = itensPedido.reduce((sum, i) => sum + i.total, 0);
            $('#subtotal').text(`R$ ${total.toFixed(2)}`);
            $('#totalPedido').text(`R$ ${total.toFixed(2)}`);

            const resumoRapido = $('#resumoRapido');
            if (itensPedido.length > 0) {
                resumoRapido.html(`
                    <div class="d-flex justify-content-between mb-2">
                        <span>Itens:</span> <strong>${itensPedido.length}</strong>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Subtotal:</span> <strong>R$ ${total.toFixed(2)}</strong>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between mb-0 h5">
                        <span>Total:</span> <strong class="text-success">R$ ${total.toFixed(2)}</strong>
                    </div>
                `);
            } else {
                resumoRapido.html('<p class="text-muted text-center py-3">Nenhum item adicionado</p>');
            }
        }

        function limparPedido() {
            if (!confirm('Limpar pedido atual?')) return;
            itensPedido = [];
            atualizarListaItens();
            $('#pedidoForm')[0].reset();
        }

        $('#pedidoForm').submit(function(e) {
            if (itensPedido.length === 0) {
                e.preventDefault();
                alert('Adicione itens ao pedido');
                return;
            }
            $(this).find('input[type="hidden"][name^="Itens"]').remove();
            itensPedido.forEach((item, index) => {
                $(this).append(`
                    <input type="hidden" name="Itens[${index}].ProdutoId" value="${item.produtoId}">
                    <input type="hidden" name="Itens[${index}].ProdutoNome" value="${item.produtoNome}">
                    <input type="hidden" name="Itens[${index}].Quantidade" value="${item.quantidade}">
                    <input type="hidden" name="Itens[${index}].Observacoes" value="${item.observacoes || ''}">
                `);
            });
        });

        function carregarProdutos(page = 1, search = '', categoria = '') {
            if (isLoading) return;
            isLoading = true;
            $('#loadingProdutos').show();
            $('#noResults').hide();

            $.get('/Pedidos/GetProdutosPaginados', {
                page: page,
                pageSize: pageSize,
                search: search,
                categoria: categoria
            }, function(data) {
                if (page === 1) $('#listaProdutos').empty();

                if (!data || !data.produtos || data.produtos.length === 0) {
                    if (page === 1) $('#noResults').show();
                    hasMore = false;
                } else {
                    data.produtos.forEach(produto => {
                        const nomeEsc = (produto.nome || '').replace(/'/g, "\\'");
                        const produtoHtml = `
                            <div class="col-md-4 col-sm-6">
                                <div class="card h-100 border-0 shadow-sm action-card" onclick="selecionarProduto(${produto.id}, '${nomeEsc}', ${parseFloat(produto.valorVenda)})" style="cursor: pointer;">
                                    <div class="card-body p-3">
                                        <h6 class="card-title mb-1 text-truncate">${produto.nome}</h6>
                                        <p class="card-text text-muted small mb-2">${produto.categoria || ''}</p>
                                        <strong class="text-success">R$ ${parseFloat(produto.valorVenda).toFixed(2)}</strong>
                                    </div>
                                </div>
                            </div>
                        `;
                        $('#listaProdutos').append(produtoHtml);
                    });
                    hasMore = page < data.totalPages;
                }
                currentPage = page;
                isLoading = false;
                $('#loadingProdutos').hide();
            });
        }

        $('#listaProdutos').on('scroll', function() {
            if (this.scrollTop + this.clientHeight >= this.scrollHeight - 50) {
                if (hasMore && !isLoading) carregarProdutos(currentPage + 1, currentSearch, currentCategoria);
            }
        });

        let searchTimeout;
        $('#searchProduto').on('input', function() {
            clearTimeout(searchTimeout);
            const termo = $(this).val().trim();
            searchTimeout = setTimeout(() => {
                currentSearch = termo;
                currentPage = 1;
                hasMore = true;
                carregarProdutos(1, currentSearch, currentCategoria);
            }, 400);
        });

        $('#filtrosCategorias').on('click', 'button', function() {
            $('#filtrosCategorias button').removeClass('active');
            $(this).addClass('active');
            currentCategoria = $(this).data('categoria') || '';
            currentPage = 1;
            hasMore = true;
            carregarProdutos(1, currentSearch, currentCategoria);
        });

        $('#produtoModal').on('show.bs.modal', function () {
            currentPage = 1;
            hasMore = true;
            carregarProdutos(1, currentSearch, currentCategoria);
        });
    </script>
    <style>
        .action-card:hover { transform: translateY(-3px); transition: all 0.2s; box-shadow: 0 4px 8px rgba(0,0,0,0.1) !important; }
    </style>
}
