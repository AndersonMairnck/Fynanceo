<!-- Views/Caixa/Dashboard.cshtml -->
@model Fynanceo.ViewModels.DashboardFinanceiroViewModel

@{
    ViewData["Title"] = "Dashboard Financeiro";
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 mb-0">
        <i class="fas fa-chart-line text-primary me-2"></i>@ViewData["Title"]
    </h1>
    <div>
        <a href="@Url.Action("Index", "Caixa")" class="btn btn-outline-secondary me-2">
            <i class="fas fa-cash-register me-2"></i>Caixas
        </a>
        <a href="@Url.Action("Index", "Contas")" class="btn btn-outline-primary">
            <i class="fas fa-file-invoice-dollar me-2"></i>Contas
        </a>
    </div>
</div>

<!-- Status do Caixa -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card @(Model.CaixaAberto ? "border-success" : "border-warning")">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h5 class="card-title mb-1">
                            <i class="fas fa-cash-register me-2"></i>
                            Status do Caixa
                        </h5>
                        <p class="card-text mb-0">
                            @if (Model.CaixaAberto)
                            {
                                <span class="text-success">
                                    <i class="fas fa-check-circle me-1"></i>
                                    <strong>CAIXA ABERTO</strong> -
                                    Saldo: <strong>R$ @Model.SaldoCaixa?.ToString("N2")</strong>
                                </span>
                            }
                            else
                            {
                                <span class="text-warning">
                                    <i class="fas fa-exclamation-triangle me-1"></i>
                                    <strong>CAIXA FECHADO</strong>
                                </span>
                            }
                        </p>
                    </div>
                    <div class="col-md-4 text-end">
                        @if (Model.CaixaAberto)
                        {
                            <a href="@Url.Action("Index", "Caixa")" class="btn btn-success">
                                <i class="fas fa-eye me-2"></i>Ver Caixa
                            </a>
                        }
                        else
                        {
                            <a href="@Url.Action("Abrir", "Caixa")" class="btn btn-primary">
                                <i class="fas fa-lock-open me-2"></i>Abrir Caixa
                            </a>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Métricas Principais -->
<div class="row mb-4">
    <div class="col-md-2">
        <div class="card bg-primary text-white">
            <div class="card-body text-center">
                <h3 class="mb-0">R$ @Model.FaturamentoMes.ToString("N2")</h3>
                <small>Faturamento Mês</small>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card bg-success text-white">
            <div class="card-body text-center">
                <h3 class="mb-0">R$ @Model.LucroMes.ToString("N2")</h3>
                <small>Lucro Mês</small>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card bg-danger text-white">
            <div class="card-body text-center">
                <h3 class="mb-0">R$ @Model.DespesasMes.ToString("N2")</h3>
                <small>Despesas Mês</small>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card bg-info text-white">
            <div class="card-body text-center">
                <h3 class="mb-0">R$ @Model.TicketMedio.ToString("N2")</h3>
                <small>Ticket Médio</small>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card bg-warning text-dark">
            <div class="card-body text-center">
                <h3 class="mb-0">@Model.ContasPendentes</h3>
                <small>Contas Pendentes</small>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card bg-dark text-white">
            <div class="card-body text-center">
                <h3 class="mb-0">@Model.ContasAtrasadas</h3>
                <small>Contas Atrasadas</small>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Métricas do Dia -->
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Hoje</h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6">
                        <h4 class="text-success">R$ @Model.TotalEntradasHoje.ToString("N2")</h4>
                        <small class="text-muted">Entradas</small>
                    </div>
                    <div class="col-6">
                        <h4 class="text-danger">R$ @Model.TotalSaidasHoje.ToString("N2")</h4>
                        <small class="text-muted">Saídas</small>
                    </div>
                </div>
                <hr>
                <div class="text-center">
                    <h5 class="@(Model.TotalEntradasHoje - Model.TotalSaidasHoje >= 0 ? "text-success" : "text-danger")">
                        R$ @((Model.TotalEntradasHoje - Model.TotalSaidasHoje).ToString("N2"))
                    </h5>
                    <small class="text-muted">Resultado do Dia</small>
                </div>
            </div>
        </div>

        <!-- Contas a Pagar/Receber -->
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0">Contas Pendentes</h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6">
                        <h5 class="text-danger">R$ @Model.TotalContasPagar.ToString("N2")</h5>
                        <small class="text-muted">A Pagar</small>
                    </div>
                    <div class="col-6">
                        <h5 class="text-success">R$ @Model.TotalContasReceber.ToString("N2")</h5>
                        <small class="text-muted">A Receber</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Gráfico de Movimentações -->
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Movimentações dos Últimos 30 Dias</h5>
            </div>
            <div class="card-body">
                <canvas id="movimentacoesChart" height="250"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Alertas -->
<div class="row mt-4">
    <!-- Contas Próximas do Vencimento -->
    <div class="col-md-6">
        <div class="card border-warning">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0">
                    <i class="fas fa-clock me-2"></i>Contas Próximas do Vencimento
                    <span class="badge bg-dark ms-2">@Model.ContasProximasVencimento.Count</span>
                </h5>
            </div>
            <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                @if (Model.ContasProximasVencimento.Any())
                {
                    foreach (var conta in Model.ContasProximasVencimento)
                    {
                        <div class="border-bottom pb-2 mb-2">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h6 class="mb-1">@conta.Descricao</h6>
                                    <small class="text-muted">
                                        @conta.Fornecedor?.Nome
                                        <br>
                                        Vencimento: <strong>@conta.DataVencimento.ToString("dd/MM/yyyy")</strong>
                                    </small>
                                </div>
                                <div class="text-end">
                                    <strong class="text-warning">R$ @conta.Valor.ToString("N2")</strong>
                                    <br>
                                    <a href="@Url.Action("Pagar", "Contas", new { id = conta.Id })"
                                       class="btn btn-sm btn-success mt-1">
                                        <i class="fas fa-check"></i>
                                    </a>
                                </div>
                            </div>
                        </div>
                    }
                }
                else
                {
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-check-circle fa-2x mb-3"></i>
                        <p>Nenhuma conta próxima do vencimento</p>
                    </div>
                }
            </div>
        </div>
    </div>

    <!-- Contas Atrasadas -->
    <div class="col-md-6">
        <div class="card border-danger">
            <div class="card-header bg-danger text-white">
                <h5 class="mb-0">
                    <i class="fas fa-exclamation-triangle me-2"></i>Contas Atrasadas
                    <span class="badge bg-light text-dark ms-2">@Model.ContasAtrasadasList.Count</span>
                </h5>
            </div>
            <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                @if (Model.ContasAtrasadasList.Any())
                {
                    foreach (var conta in Model.ContasAtrasadasList)
                    {
                        var diasAtraso = (DateTime.Today - conta.DataVencimento).Days;

                        <div class="border-bottom pb-2 mb-2">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h6 class="mb-1 text-danger">@conta.Descricao</h6>
                                    <small class="text-muted">
                                        @conta.Fornecedor?.Nome
                                        <br>
                                        Vencido: <strong>@conta.DataVencimento.ToString("dd/MM/yyyy")</strong>
                                        <span class="badge bg-danger ms-1">@diasAtraso dias</span>
                                    </small>
                                </div>
                                <div class="text-end">
                                    <strong class="text-danger">R$ @conta.Valor.ToString("N2")</strong>
                                    <br>
                                    <a href="@Url.Action("Pagar", "Contas", new { id = conta.Id })"
                                       class="btn btn-sm btn-danger mt-1">
                                        <i class="fas fa-check"></i>
                                    </a>
                                </div>
                            </div>
                        </div>
                    }
                }
                else
                {
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-check-circle fa-2x mb-3"></i>
                        <p>Nenhuma conta atrasada</p>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<!-- Ações Rápidas -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Ações Rápidas</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 mb-2">
                        @if (Model.CaixaAberto)
                        {
                            <a href="@Url.Action("Index", "Caixa")" class="btn btn-outline-success w-100">
                                <i class="fas fa-cash-register me-2"></i>Ver Caixa
                            </a>
                        }
                        else
                        {
                            <a href="@Url.Action("Abrir", "Caixa")" class="btn btn-outline-primary w-100">
                                <i class="fas fa-lock-open me-2"></i>Abrir Caixa
                            </a>
                        }
                    </div>
                    <div class="col-md-3 mb-2">
                        <a href="@Url.Action("Create", "Contas")" class="btn btn-outline-warning w-100">
                            <i class="fas fa-plus me-2"></i>Nova Conta
                        </a>
                    </div>
                    <div class="col-md-3 mb-2">
                        <a href="@Url.Action("Pendentes", "Contas")" class="btn btn-outline-info w-100">
                            <i class="fas fa-file-invoice me-2"></i>Contas Pendentes
                        </a>
                    </div>
                    <div class="col-md-3 mb-2">
                        <a href="@Url.Action("Index", "Fornecedores")" class="btn btn-outline-secondary w-100">
                            <i class="fas fa-truck me-2"></i>Fornecedores
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        // Gráfico de Movimentações
        const movimentacoesData = @Html.Raw(Json.Serialize(Model.MovimentacoesDiarias));

        const labels = movimentacoesData.map(m => {
            const date = new Date(m.data);
            return date.toLocaleDateString('pt-BR');
        });

        const entradas = movimentacoesData.map(m => m.entradas);
        const saidas = movimentacoesData.map(m => m.saidas);

        const ctx = document.getElementById('movimentacoesChart').getContext('2d');
        const chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Entradas',
                        data: entradas,
                        borderColor: '#28a745',
                        backgroundColor: 'rgba(40, 167, 69, 0.1)',
                        tension: 0.4,
                        fill: true
                    },
                    {
                        label: 'Saídas',
                        data: saidas,
                        borderColor: '#dc3545',
                        backgroundColor: 'rgba(220, 53, 69, 0.1)',
                        tension: 0.4,
                        fill: true
                    }
                ]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': R$ ' + context.parsed.y.toFixed(2);
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return 'R$ ' + value.toFixed(2);
                            }
                        }
                    }
                }
            }
        });

        // Auto-refresh a cada 2 minutos
        setInterval(() => {
            location.reload();
        }, 120000);
    </script>
}