@using Fynanceo.ViewModel
@using Fynanceo.ViewModel.DeliveryModel
<!-- Views/Entregas/Create.cshtml -->
@model EntregaViewModel

@{
    ViewData["Title"] = "Nova Entrega";
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 mb-0">
        <i class="fas fa-plus-circle text-primary me-2"></i>@ViewData["Title"]
    </h1>
    <a href="@Url.Action("Index")" class="btn btn-outline-secondary">
        <i class="fas fa-arrow-left me-2"></i>Voltar
    </a>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Informações da Entrega</h5>
            </div>
            <div class="card-body">
                <form asp-action="Create">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="PedidoId" class="form-label">Pedido *</label>
                                <select asp-for="PedidoId" class="form-select" required id="pedidoSelect">
                                    <option value="">Selecione um pedido...</option>
                                    @foreach (var pedido in Model.PedidosPendentes ?? new List<Fynanceo.Models.Pedido>())
                                    {
                                        <option value="@pedido.Id"
                                                data-cliente="@pedido.Cliente?.NomeCompleto"
                                                data-telefone="@pedido.Cliente?.Telefone"
                                                data-endereco="@pedido.EnderecoEntrega?.ToString()"
                                                data-complemento="@pedido.EnderecoEntrega?.Complemento"
                                                data-taxa="@pedido.TaxaEntrega">
                                            @pedido.NumeroPedido - @pedido.Cliente?.NomeCompleto - R$ @pedido.Total.ToString("N2")
                                        </option>
                                    }
                                </select>
                                <span asp-validation-for="PedidoId" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="EntregadorId" class="form-label">Entregador</label>
                                <select asp-for="EntregadorId" class="form-select" id="entregadorSelect">
                                    <option value="">Não atribuir agora</option>
                                    @foreach (var entregador in Model.EntregadoresDisponiveis ?? new List<Fynanceo.Models.Entregador>())
                                    {
                                        <option value="@entregador.Id">
                                            @entregador.Nome - @entregador.Telefone (@entregador.TipoVeiculo)
                                        </option>
                                    }
                                </select>
                                <span asp-validation-for="EntregadorId" class="text-danger"></span>
                            </div>
                        </div>
                    </div>

                    <!-- Informações do Pedido Selecionado -->
                    <div id="pedidoInfo" class="alert alert-info" style="display: none;">
                        <div class="row">
                            <div class="col-md-6">
                                <strong>Cliente:</strong> <span id="infoCliente"></span><br>
                                <strong>Telefone:</strong> <span id="infoTelefone"></span>
                            </div>
                            <div class="col-md-6">
                                <strong>Endereço:</strong> <span id="infoEndereco"></span><br>
                                <strong>Complemento:</strong> <span id="infoComplemento"></span><br>
                                <strong>Taxa:</strong> R$ <span id="infoTaxa"></span>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label asp-for="Instrucoes" class="form-label">Instruções Especiais</label>
                        <textarea asp-for="Instrucoes" class="form-control" rows="3" placeholder="Instruções para a entrega..."></textarea>
                        <span asp-validation-for="Instrucoes" class="text-danger"></span>
                    </div>

                    <div class="d-grid">
                        <button type="submit" class="btn btn-success btn-lg">
                            <i class="fas fa-check me-2"></i>Criar Entrega
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <!-- Resumo -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Resumo</h5>
            </div>
            <div class="card-body">
                <div id="resumoEntrega">
                    <p class="text-muted">Selecione um pedido para ver as informações</p>
                </div>
            </div>
        </div>

        <!-- Ajuda -->
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0">Como Funciona</h5>
            </div>
            <div class="card-body">
                <ol class="small">
                    <li>Selecione um pedido do tipo delivery</li>
                    <li>Escolha um entregador disponível (opcional)</li>
                    <li>Adicione instruções especiais se necessário</li>
                    <li>Clique em "Criar Entrega"</li>
                </ol>
                <div class="alert alert-warning small">
                    <i class="fas fa-info-circle me-2"></i>
                    Pedidos sem entregador atribuído ficarão na lista de pendentes
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $('#pedidoSelect').change(function() {
            const selectedOption = $(this).find('option:selected');
            const cliente = selectedOption.data('cliente');
            const telefone = selectedOption.data('telefone');
            const endereco = selectedOption.data('endereco');
            const complemento = selectedOption.data('complemento');
            const taxa = selectedOption.data('taxa');

            if (cliente) {
                $('#pedidoInfo').show();
                $('#infoCliente').text(cliente);
                $('#infoTelefone').text(telefone || 'Não informado');
                $('#infoEndereco').text(endereco);
                $('#infoComplemento').text(complemento || 'Não informado');
                $('#infoTaxa').text(parseFloat(taxa).toFixed(2));

                $('#resumoEntrega').html(`
                    <p><strong>Pedido:</strong> ${selectedOption.text()}</p>
                    <p><strong>Cliente:</strong> ${cliente}</p>
                    <p><strong>Endereço:</strong> ${endereco}</p>
                    <p><strong>Taxa de Entrega:</strong> R$ ${parseFloat(taxa).toFixed(2)}</p>
                `);
            } else {
                $('#pedidoInfo').hide();
                $('#resumoEntrega').html('<p class="text-muted">Selecione um pedido para ver as informações</p>');
            }
        });
    </script>
}